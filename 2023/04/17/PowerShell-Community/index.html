<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">

<script>

    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();

</script>








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/hacker-32x32.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/hacker-16x16.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="学习笔记,PowerShell Community," />





  <link rel="alternate" href="/atom.xml" title="Ax-x" type="application/atom+xml" />






<meta name="description" content="学习链接： https:&#x2F;&#x2F;devblogs.microsoft.com&#x2F;scripting&#x2F; https:&#x2F;&#x2F;devblogs.microsoft.com&#x2F;powershell-community&#x2F; https:&#x2F;&#x2F;blog.csdn.net&#x2F;culinxia2707&#x2F;article&#x2F;details&#x2F;108771878">
<meta property="og:type" content="article">
<meta property="og:title" content="PowerShell Community">
<meta property="og:url" content="https://ax-x.github.io/2023/04/17/PowerShell-Community/index.html">
<meta property="og:site_name" content="Ax-x">
<meta property="og:description" content="学习链接： https:&#x2F;&#x2F;devblogs.microsoft.com&#x2F;scripting&#x2F; https:&#x2F;&#x2F;devblogs.microsoft.com&#x2F;powershell-community&#x2F; https:&#x2F;&#x2F;blog.csdn.net&#x2F;culinxia2707&#x2F;article&#x2F;details&#x2F;108771878">
<meta property="og:locale">
<meta property="og:image" content="https://ax-x.github.io/2023/04/17/PowerShell-Community/安全学习资料\文稿\16、钓鱼\关于PowerShell\1672938921071-3f3107cc-9101-4836-b9da-40c9005e136a.png">
<meta property="article:published_time" content="2023-04-17T01:45:01.000Z">
<meta property="article:modified_time" content="2023-04-17T01:49:19.362Z">
<meta property="article:author" content="Ax-x">
<meta property="article:tag" content="学习笔记">
<meta property="article:tag" content="PowerShell Community">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ax-x.github.io/2023/04/17/PowerShell-Community/安全学习资料\文稿\16、钓鱼\关于PowerShell\1672938921071-3f3107cc-9101-4836-b9da-40c9005e136a.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://ax-x.github.io/2023/04/17/PowerShell-Community/"/>





  <title>PowerShell Community | Ax-x</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ax-x</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">以有限的时间，做无限的事情</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            日程表
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ax-x.github.io/2023/04/17/PowerShell-Community/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/head_portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ax-x">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">PowerShell Community</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-04-17T09:45:01+08:00">
                2023-04-17
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2023-04-17T09:49:19+08:00">
                2023-04-17
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PowerShell/" itemprop="url" rel="index">
                    <span itemprop="name">PowerShell</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  13.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  56
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>学习链接：</strong></p>
<p><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/scripting/">https://devblogs.microsoft.com/scripting/</a></p>
<p><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/powershell-community/">https://devblogs.microsoft.com/powershell-community/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/culinxia2707/article/details/108771878">https://blog.csdn.net/culinxia2707/article/details/108771878</a></p>
<span id="more"></span>

<h2 id="通过PowerShell更改驱动器字母和标签"><a href="#通过PowerShell更改驱动器字母和标签" class="headerlink" title="通过PowerShell更改驱动器字母和标签"></a>通过PowerShell更改驱动器字母和标签</h2><p>问题：如何通过PowerShell更改驱动器字母和标签？</p>
<p>解答：其中一种方法是通过WMI和CIM命令来修改。</p>
<p>PowerShell没有cmdlet来直接更改驱动器号或标题，但好消息是，您可以使用WMI和CIM cmdlet来更改驱动器号和驱动器标签。Windows管理工具有cmdlet (<code>Set-Partition</code>和<code>Set-Volume</code>)可以直接修改盘符和标题。但是知道如何通过WMI和CIM cmdlet来更改驱动器号和驱动器标签也是很有帮助的。实际上，当你使用<code>Set-Partition</code>时，你实际上是在使用WMI。Windows存储和Windows网络团队都大量使用WMI，并通过CDXML模块公开cmdlet。</p>
<ul>
<li>WMI系统类是基于公共信息模型(CIM)的预定义类的集合。</li>
</ul>
<h3 id="WMI类，类属性和类方法"><a href="#WMI类，类属性和类方法" class="headerlink" title="WMI类，类属性和类方法"></a>WMI类，类属性和类方法</h3><p>WMI以WMI类的形式保存了大量关于Windows主机的信息。每个IT专业人士都应该了解WMI。</p>
<p>WMI拥有一个类和类事件(class occurrences)的层次数据库，呈树形结构。这些类描述了计算机中的硬件和软件。这个数据库被组织成命名空间，每个命名空间包含类和可选的附加命名空间。您可以使用CIM cmdlet来检索和更新此信息。命名空间的根是root，在它的下面还有十几个命名空间，最常用的是root\cimv2。命名空间的信息存储在静态类__Namespace类中，要查询当前命名空间下的所有命名空间，可以查看__Namespace类的实例。使用PowerShell查询命名空间：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-WmiObject</span> <span class="literal">-Class</span> __namespace <span class="literal">-Namespace</span> root | <span class="built_in">select</span> name</span><br></pre></td></tr></table></figure>

<p>例如，您可以从<code>**Win32_Volume**</code>类中发现驱动器的驱动器号和驱动器标签。该类位于<code>rootCimV2</code>名称空间中。</p>
<p>许多WMI类还包含可作用于WMI对象的方法。可以使用<code>**Win32_Volume**</code>类的<code>Format()</code>方法格式化Windows卷。</p>
<p>要获取WMI类的属性值，或者调用类方法，可以使用WMI cmdlet，它随Windows PowerShell V1附带。但是，这些cmdlet不再随PowerShell 7一起发布。当然，一个坚定的IT专业人士可以找到解决这个问题的方法，但你不必这么做。</p>
<p>在PowerShell 7中，您可以使用CIM cmdlet来访问这些信息。CIM cmdlet首先与Windows PowerShell V3一起发布，并代表了IT专业人员访问WMI的重大改革。更新的cmdlet与WMI cmdlet完成相同的工作，但是具有不同的cmdlet，以及不同的工作方式，正如您在本文中看到的那样。</p>
<h3 id="探索WMI类属性"><a href="#探索WMI类属性" class="headerlink" title="探索WMI类属性"></a>探索WMI类属性</h3><p>使用cmdlet <code>Get-CimClass</code>来发现任何给定类的属性的名称(和类型)。您可以像这样发现<code>**Win32_Volume**</code>类的属性。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-CimClass</span> <span class="literal">-ClassName</span> Win32_Volume |</span><br><span class="line">  <span class="built_in">Select-Object</span> <span class="literal">-ExpandProperty</span> CimClassProperties |</span><br><span class="line">    <span class="built_in">Sort-Object</span> <span class="literal">-Property</span> Name |</span><br><span class="line">      <span class="built_in">Format-Table</span> Name, CimType, Qualifiers</span><br></pre></td></tr></table></figure>

<p>该命令的输出如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Name                             CimType Qualifiers</span><br><span class="line">----                             ------- ----------</span><br><span class="line">Access                            UInt16 &#123;read&#125;</span><br><span class="line">Automount                        Boolean &#123;read&#125;</span><br><span class="line">Availability                      UInt16 &#123;MappingStrings, read, ValueMap&#125;</span><br><span class="line">BlockSize                         UInt64 &#123;MappingStrings, read&#125;</span><br><span class="line">BootVolume                       Boolean &#123;read&#125;</span><br><span class="line">Capacity                          UInt64 &#123;read&#125;</span><br><span class="line">Caption                           String &#123;MaxLen, read&#125;</span><br><span class="line">Compressed                       Boolean &#123;read&#125;</span><br><span class="line">ConfigManagerErrorCode            UInt32 &#123;read, Schema, ValueMap&#125;</span><br><span class="line">ConfigManagerUserConfig          Boolean &#123;read, Schema&#125;</span><br><span class="line">CreationClassName                 String &#123;CIM_Key, read&#125;</span><br><span class="line">Description                       String &#123;read&#125;</span><br><span class="line">DeviceID                          String &#123;CIM_Key, read, key, MappingStrings, Override&#125;</span><br><span class="line">DirtyBitSet                      Boolean &#123;read&#125;</span><br><span class="line">DriveLetter                       String &#123;read, <span class="built_in">write</span>&#125;</span><br><span class="line">DriveType                         UInt32 &#123;MappingStrings, read&#125;</span><br><span class="line">ErrorCleared                     Boolean &#123;read&#125;</span><br><span class="line">ErrorDescription                  String &#123;read&#125;</span><br><span class="line">ErrorMethodology                  String &#123;read&#125;</span><br><span class="line">FileSystem                        String &#123;read&#125;</span><br><span class="line">FreeSpace                         UInt64 &#123;read&#125;</span><br><span class="line">IndexingEnabled                  Boolean &#123;read, <span class="built_in">write</span>&#125;</span><br><span class="line">InstallDate                     DateTime &#123;MappingStrings, read&#125;</span><br><span class="line">Label                             String &#123;read, <span class="built_in">write</span>&#125;</span><br><span class="line">LastErrorCode                     UInt32 &#123;read&#125;</span><br><span class="line">MaximumFileNameLength             UInt32 &#123;read&#125;</span><br><span class="line">Name                              String &#123;read&#125;</span><br><span class="line">NumberOfBlocks                    UInt64 &#123;MappingStrings&#125;</span><br><span class="line">PageFilePresent                  Boolean &#123;read&#125;</span><br><span class="line">PNPDeviceID                       String &#123;read, Schema&#125;</span><br><span class="line">PowerManagementCapabilities  UInt16Array &#123;read&#125;</span><br><span class="line">PowerManagementSupported         Boolean &#123;read&#125;</span><br><span class="line">Purpose                           String &#123;read&#125;</span><br><span class="line">QuotasEnabled                    Boolean &#123;read&#125;</span><br><span class="line">QuotasIncomplete                 Boolean &#123;read&#125;</span><br><span class="line">QuotasRebuilding                 Boolean &#123;read&#125;</span><br><span class="line">SerialNumber                      UInt32 &#123;read&#125;</span><br><span class="line">Status                            String &#123;MaxLen, read, ValueMap&#125;</span><br><span class="line">StatusInfo                        UInt16 &#123;MappingStrings, read, ValueMap&#125;</span><br><span class="line">SupportsDiskQuotas               Boolean &#123;read&#125;</span><br><span class="line">SupportsFileBasedCompression     Boolean &#123;read&#125;</span><br><span class="line">SystemCreationClassName           String &#123;CIM_Key, Propagated, read&#125;</span><br><span class="line">SystemName                        String &#123;CIM_Key, Propagated, read&#125;</span><br><span class="line">SystemVolume                     Boolean &#123;read&#125;</span><br></pre></td></tr></table></figure>

<p>在这个列表中，您可以看到<code>**Win32_Volume**</code> WMI类的每个属性、属性的数据类型和限定符。限定符告诉您有关属性的更多信息，特别是给定属性是只读还是读写。<code>PageFilePresent</code>属性表示给定卷是否包含Windows分页文件。不能使用CIM cmdlet更改此属性。另一方面，<code>DriveLetter</code>和<code>Label</code>属性是可以更改的。让我们看看如何更改这些属性。</p>
<h3 id="获取WMI属性"><a href="#获取WMI属性" class="headerlink" title="获取WMI属性"></a>获取WMI属性</h3><p>假设要更改磁盘驱动器的卷标签。在我的主机中，M:驱动器包含了数字化音乐的收藏。但有时，当我插入USB备份驱动器执行备份时，Windows会为我更改驱动器号。为了确保我的备份脚本工作，我需要把它改回来，这样我的备份脚本才能正常工作。</p>
<p>驱动器标签和驱动器号的值可以通过该操作获取：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Drive</span> = <span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Volume <span class="literal">-Filter</span> <span class="string">&quot;DriveLetter = &#x27;M:&#x27;&quot;</span></span><br><span class="line"><span class="variable">$Drive</span> | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> SystemName, Label, DriveLetter</span><br></pre></td></tr></table></figure>

<p>在我的Windows 10主机(Cookham24)上，输出如下所示</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$Drive</span> | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> SystemName, DriveLetter, Label, DriveLetter</span><br><span class="line"></span><br><span class="line">SystemName Label		 DriveLetter</span><br><span class="line">---------- ----- 		 -----------</span><br><span class="line">COOKHAM24  Master GD M:         </span><br></pre></td></tr></table></figure>

<h3 id="更换驱动器标签"><a href="#更换驱动器标签" class="headerlink" title="更换驱动器标签"></a>更换驱动器标签</h3><p>我们在上面看到驱动器标签和驱动器号都是可写属性。若要更改此磁盘卷的标签，请为**$Drive**的<code>label</code>属性分配一个新值。更改属性值将更新内存中的类实例，这不是永久更改。为了保持更改，您需要使用<code>Set-CimInstance</code> CMDLET。以下是更改驱动器标签，然后确认更改的方法：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Drive</span> = <span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Volume <span class="literal">-Filter</span> <span class="string">&quot;DriveLetter = &#x27;M:&#x27;&quot;</span></span><br><span class="line"><span class="variable">$Drive</span> | <span class="built_in">Set-CimInstance</span> <span class="literal">-Property</span> <span class="selector-tag">@</span>&#123;Label=<span class="string">&#x27;Grateful Dead&#x27;</span>&#125;</span><br><span class="line"><span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Volume <span class="literal">-Filter</span> <span class="string">&quot;DriveLetter = &#x27;M:&#x27;&quot;</span> |</span><br><span class="line">  <span class="built_in">Select-Object</span> <span class="literal">-Property</span> SystemName, Label, DriveLetter</span><br></pre></td></tr></table></figure>

<p>该命令的输出显示了更新后的系统标签，如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SystemName Label         DriveLetter</span><br><span class="line">---------- -----         -----------</span><br><span class="line">COOKHAM24  Grateful Dead M:  </span><br></pre></td></tr></table></figure>

<h3 id="更换驱动器号"><a href="#更换驱动器号" class="headerlink" title="更换驱动器号"></a>更换驱动器号</h3><p>要更改卷的驱动器号，可以使用<code>Set-CimInstance</code>更改驱动器号，如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Drive</span> = <span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Volume <span class="literal">-Filter</span> <span class="string">&quot;DriveLetter = &#x27;M:&#x27;&quot;</span></span><br><span class="line"><span class="variable">$Drive</span> | <span class="built_in">Set-CimInstance</span> <span class="literal">-Property</span> <span class="selector-tag">@</span>&#123;DriveLetter =<span class="string">&#x27;X:&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>如果您在非管理员会话中运行PowerShell 7，此操作将失败，如下所示</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:Foo&gt; <span class="variable">$Drive</span> = <span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Volume <span class="literal">-Filter</span> <span class="string">&quot;DriveLetter = &#x27;M:&#x27;&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:Foo&gt; <span class="variable">$Drive</span> | <span class="built_in">Set-CimInstance</span> <span class="literal">-Property</span> <span class="selector-tag">@</span>&#123;DriveLetter =<span class="string">&#x27;X:&#x27;</span>&#125;</span><br><span class="line"><span class="built_in">Set-CimInstance</span>: Access is denied.</span><br></pre></td></tr></table></figure>

<p>此错误是意料之中的，因为您不是以管理员身份运行PowerShell。要克服此错误，请在提升会话中重新运行该命令(以管理员身份运行)。然后输出是这样的：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:Foo&gt; <span class="variable">$Drive</span> = <span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Volume <span class="literal">-Filter</span> <span class="string">&quot;DriveLetter = &#x27;M:&#x27;&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:Foo&gt; <span class="variable">$Drive</span> | <span class="built_in">Set-CimInstance</span> <span class="literal">-Property</span> <span class="selector-tag">@</span>&#123;DriveLetter =<span class="string">&#x27;X:&#x27;</span>&#125;</span><br><span class="line"><span class="built_in">PS</span> C:Foo&gt; <span class="built_in">Get-Volume</span> | <span class="built_in">Where-Object</span> FileSystemLabel <span class="operator">-eq</span> <span class="string">&#x27;Grateful Dead&#x27;</span></span><br><span class="line"></span><br><span class="line">DriveLetter FriendlyName  FileSystemType DriveType HealthStatus OperationalStatus SizeRemaining    Size</span><br><span class="line">----------- ------------  -------------- --------- ------------ ----------------- -------------    ----</span><br><span class="line">X           Grateful Dead NTFS           Fixed     Healthy      OK                <span class="number">591.78</span> GB        <span class="number">3.64</span> TB</span><br></pre></td></tr></table></figure>

<p>更改驱动器号需要一段时间，所以要有耐心。</p>
<p>最后一点，您可以将两个属性更新合并到一个<code>Set-CimInstance</code>调用中。要将该驱动器恢复到旧驱动器号(M:)和它的标签(GD Master)并确认更改，可以这样做：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Drive</span> = <span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Volume <span class="literal">-Filter</span> <span class="string">&quot;DriveLetter = &#x27;X:&#x27;&quot;</span></span><br><span class="line"><span class="variable">$Drive</span> | <span class="built_in">Set-CimInstance</span> <span class="literal">-Property</span> <span class="selector-tag">@</span>&#123;DriveLetter = <span class="string">&#x27;M:&#x27;</span>; Label = <span class="string">&#x27;GD Master&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>您可以使用Get-Volume查看驱动器号和标签的更改结果。输出应该如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:Foo&gt; <span class="built_in">Get-Volume</span> | <span class="built_in">Where-Object</span> FileSystemLabel <span class="operator">-match</span> <span class="string">&#x27;GD Master&#x27;</span></span><br><span class="line">DriveLetter FriendlyName FileSystemType DriveType HealthStatus OperationalStatus SizeRemaining    Size</span><br><span class="line">----------- ------------ -------------- --------- ------------ ----------------- -------------    ----</span><br><span class="line">M           GD Master    NTFS           Fixed     Healthy      OK                <span class="number">591.78</span> GB        <span class="number">3.64</span> TB</span><br></pre></td></tr></table></figure>

<p>注意：当您更改驱动器号然后将其还原时，您可能会遇到一个问题，如下所示。Windows似乎保留了旧的驱动器号，不允许您立即将其恢复。因此，当试图恢复驱动器号时，您可能会得到一个<code>Set-CimInstance: not available</code>错误消息。为了解决这个问题，你必须重新启动Windows，只是注销和休眠是不行的。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>使用PowerShell 7更改驱动器号简单而直接。可以看到，使用<code>Set-CimInstance</code> PowerShell cmdlet修改可写WMI属性非常简单。我觉得这比做多个属性值赋值更直观(一旦你掌握了哈希表)。最酷的是可以一次修改多个属性，而不是进行大量赋值。</p>
<p>一如既往，这篇文章表明，实现任何目标的方法往往不止一种。</p>
<h3 id="致敬感谢"><a href="#致敬感谢" class="headerlink" title="致敬感谢"></a>致敬感谢</h3><p>本文的灵感来自于以前的一篇Scripting Guys博客文章:<a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/scripting/change-drive-letters-and-labels-via-a-simple-powershell-command/">Change drive letters and labels via a simple PowerShell command</a>。那篇文章是由最优秀的Ed Wilson写的，谢谢Ed！</p>
<h2 id="对比在PowerShell-7和Windows-PowerShell-5-1中使用Get-Service"><a href="#对比在PowerShell-7和Windows-PowerShell-5-1中使用Get-Service" class="headerlink" title="对比在PowerShell 7和Windows PowerShell 5.1中使用Get-Service"></a>对比在PowerShell 7和Windows PowerShell 5.1中使用Get-Service</h2><p>问题：如何获取Windows服务的Username和StartType？</p>
<p>解答：使用Powershell 7。</p>
<p>PowerShell版本信息存储在$psversiontable和$host变量中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$psversiontable</span></span><br><span class="line"></span><br><span class="line">Name                           Value</span><br><span class="line">----                           -----</span><br><span class="line">PSVersion                      <span class="number">5.1</span>.<span class="number">19041.2364</span></span><br><span class="line">PSEdition                      Desktop</span><br><span class="line">PSCompatibleVersions           &#123;<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>...&#125;</span><br><span class="line">BuildVersion                   <span class="number">10.0</span>.<span class="number">19041.2364</span></span><br><span class="line">CLRVersion                     <span class="number">4.0</span>.<span class="number">30319.42000</span></span><br><span class="line">WSManStackVersion              <span class="number">3.0</span></span><br><span class="line">PSRemotingProtocolVersion      <span class="number">2.3</span></span><br><span class="line">SerializationVersion           <span class="number">1.1</span>.<span class="number">0.1</span></span><br></pre></td></tr></table></figure>

<p>微软在每个版本的PowerShell上都做得很好。这个问题的简单答案是一个名为<code>Get-Service</code>的命令。但是PowerShell 7有一个很大的更新，可以更容易地获取所需的信息。我将使用PowerShell 7和Windows PowerShell 5.1显示此命令的结果。</p>
<p>让我们从键入简单的<code>Get-Service Workstation</code>命令开始。此命令返回名为Workstation的服务的基本详细信息。PowerShell 7和Windows PowerShell 5.1的结果是相同的。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Status   Name               DisplayName</span><br><span class="line">------   ----               -----------</span><br><span class="line">Running  LanmanWorkstation  Workstation</span><br></pre></td></tr></table></figure>

<p>要向下追踪并获得更详细的结果，我们需要查看此服务的所有相关属性和方法，可以使用以下命令实现。</p>
<h3 id="使用Get-Service获取Windows服务属性"><a href="#使用Get-Service获取Windows服务属性" class="headerlink" title="使用Get-Service获取Windows服务属性"></a>使用Get-Service获取Windows服务属性</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Service</span> Workstation | <span class="built_in">Get-Member</span> | <span class="built_in">Select-Object</span> Name, MemberType</span><br></pre></td></tr></table></figure>

<p>输出返回一个可以在命令行中调用的成员列表。下面是PowerShell 7中的输出。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Name                         MemberType</span><br><span class="line">----                         ----------</span><br><span class="line">Name                      AliasProperty</span><br><span class="line">RequiredServices          AliasProperty</span><br><span class="line">Disposed                          Event</span><br><span class="line">Close                            Method</span><br><span class="line"><span class="keyword">Continue</span>                         Method</span><br><span class="line">Dispose                          Method</span><br><span class="line">Equals                           Method</span><br><span class="line">ExecuteCommand                   Method</span><br><span class="line">GetHashCode                      Method</span><br><span class="line">GetLifetimeService               Method</span><br><span class="line">GetType                          Method</span><br><span class="line">InitializeLifetimeService        Method</span><br><span class="line">Pause                            Method</span><br><span class="line">Refresh                          Method</span><br><span class="line"><span class="built_in">Start</span>                            Method</span><br><span class="line">Stop                             Method</span><br><span class="line">WaitForStatus                    Method</span><br><span class="line">BinaryPathName                 Property</span><br><span class="line">CanPauseAndContinue            Property</span><br><span class="line">CanShutdown                    Property</span><br><span class="line">CanStop                        Property</span><br><span class="line">Container                      Property</span><br><span class="line">DelayedAutoStart               Property</span><br><span class="line">DependentServices              Property</span><br><span class="line">Description                    Property</span><br><span class="line">DisplayName                    Property</span><br><span class="line">MachineName                    Property</span><br><span class="line">ServiceHandle                  Property</span><br><span class="line">ServiceName                    Property</span><br><span class="line">ServicesDependedOn             Property</span><br><span class="line">ServiceType                    Property</span><br><span class="line">Site                           Property</span><br><span class="line">StartType                      Property</span><br><span class="line">StartupType                    Property</span><br><span class="line">Status                         Property</span><br><span class="line">UserName                       Property</span><br><span class="line">ToString                   ScriptMethod</span><br></pre></td></tr></table></figure>

<p>下面是Windows PowerShell 5.1中的输出。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Name                         MemberType</span><br><span class="line">----                         ----------</span><br><span class="line">Name                      AliasProperty</span><br><span class="line">RequiredServices          AliasProperty</span><br><span class="line">Disposed                          Event</span><br><span class="line">Close                            Method</span><br><span class="line"><span class="keyword">Continue</span>                         Method</span><br><span class="line">CreateObjRef                     Method</span><br><span class="line">Dispose                          Method</span><br><span class="line">Equals                           Method</span><br><span class="line">ExecuteCommand                   Method</span><br><span class="line">GetHashCode                      Method</span><br><span class="line">GetLifetimeService               Method</span><br><span class="line">GetType                          Method</span><br><span class="line">InitializeLifetimeService        Method</span><br><span class="line">Pause                            Method</span><br><span class="line">Refresh                          Method</span><br><span class="line"><span class="built_in">Start</span>                            Method</span><br><span class="line">Stop                             Method</span><br><span class="line">WaitForStatus                    Method</span><br><span class="line">CanPauseAndContinue            Property</span><br><span class="line">CanShutdown                    Property</span><br><span class="line">CanStop                        Property</span><br><span class="line">Container                      Property</span><br><span class="line">DependentServices              Property</span><br><span class="line">DisplayName                    Property</span><br><span class="line">MachineName                    Property</span><br><span class="line">ServiceHandle                  Property</span><br><span class="line">ServiceName                    Property</span><br><span class="line">ServicesDependedOn             Property</span><br><span class="line">ServiceType                    Property</span><br><span class="line">Site                           Property</span><br><span class="line">StartType                      Property</span><br><span class="line">Status                         Property</span><br><span class="line">ToString                   ScriptMethod</span><br></pre></td></tr></table></figure>

<h3 id="PowerShell-7"><a href="#PowerShell-7" class="headerlink" title="PowerShell 7"></a>PowerShell 7</h3><p>最大的区别在于属性成员。现在，在PowerShell 7中，可以读取一些在Windows PowerShell 5.1中不可用的附加属性，如UserName, BinaryPathName, StartType。因此，让我们看看如何使用PowerShell 7读取这些属性。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> <span class="number">7</span>&gt; <span class="built_in">Get-Service</span> workstation | <span class="built_in">select</span>  Username,Starttype,BinaryPathName</span><br></pre></td></tr></table></figure>

<p>输出是清晰的，使用本机一行命令可以得到所有所需的结果。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UserName                    StartType BinaryPathName</span><br><span class="line">--------                    --------- --------------</span><br><span class="line">NT AUTHORITY\NetworkService Automatic C:\WINDOWS\System32\svchost.exe <span class="literal">-k</span> NetworkService <span class="literal">-p</span></span><br></pre></td></tr></table></figure>

<h3 id="Windows-Powershell-5-1"><a href="#Windows-Powershell-5-1" class="headerlink" title="Windows Powershell 5.1"></a>Windows Powershell 5.1</h3><p>对于Windows PowerShell 5.1，操作不像PowerShell那样简单。我们需要使用<code>Get-CimInstance</code>并传递所需的WQL查询。因此，在Windows PowerShell 5.1中，运行以下命令：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WPS <span class="number">5.1</span>&gt; <span class="built_in">Get-CimInstance</span> <span class="literal">-Query</span> <span class="string">&#x27;select * from Win32_Service where caption like &quot;Workstation&quot;&#x27;</span> | <span class="built_in">select</span> StartName,StartMode,PathName</span><br></pre></td></tr></table></figure>

<p>返回如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StartName                   StartMode PathName</span><br><span class="line">---------                   --------- --------</span><br><span class="line">NT AUTHORITY\NetworkService Auto      C:WINDOWS\System32\svchost.exe <span class="literal">-k</span> NetworkService <span class="literal">-p</span></span><br></pre></td></tr></table></figure>

<p>在本例中，我们使用查询调用<code>Get-CimInstance</code>以获取服务名称，然后选择所需的属性，这需要您了解与原始服务名称相关的额外信息和一些基本的WMI查询语言。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>PowerShell 7自带的功能越来越多，使用方便，向后兼容性丰富得多。这篇文章展示了PowerShell中一个小变化的一小部分，它将帮助许多管理员完成日常任务。</p>
<h2 id="获取昨天的日期"><a href="#获取昨天的日期" class="headerlink" title="获取昨天的日期"></a>获取昨天的日期</h2><p>问题：怎么才能获取昨天的日期？</p>
<p>解答：您可以组合使用<code>Get-Date</code> CMDLET和<code>.NET Time/Date</code>方法。</p>
<p>首先，让我们看看PowerShell和.NET中的日期，然后我们可以看看如何计算昨天并在脚本中使用它。</p>
<h3 id="PowerShell中的日期"><a href="#PowerShell中的日期" class="headerlink" title="PowerShell中的日期"></a>PowerShell中的日期</h3><p>让我们从如何处理日期(date)和时间(time)开始。您可能知道，PowerShell包含<code>Get-Date</code> cmdlet。这个cmdlet返回一个<code>.NET **System.DateTime**</code>对象。</p>
<p>使用<code>Get-Date</code> cmdlet，您可以获取任何日期和时间，并将其显示或存储在变量中。为了知道今天的日期。你可以这样做：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:&gt; <span class="comment"># Get the current date</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="built_in">Get-Date</span></span><br><span class="line"><span class="number">08</span> January <span class="number">2021</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">46</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Store the date in a variable</span></span><br><span class="line"><span class="variable">$Now</span> = <span class="built_in">Get-Date</span></span><br><span class="line"><span class="variable">$Now</span></span><br><span class="line"><span class="number">08</span> January <span class="number">2021</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">47</span></span><br></pre></td></tr></table></figure>

<p>如前所述，<code>Get-Date</code>cmdlet返回一个类型为<code>System.DateTime</code>的对象。这个 .NET 结构提供了一组丰富的属性和方法来帮助您操作日期/时间对象。 有关此结构的更多详细信息，请参阅 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/dotnet/api/system.datetime">System.DateTime 文档</a>。 日期和时间对象包含日期和时间。 这意味着您可以创建一个只有日期或只有时间或两者都有的对象，这为您处理日期和时间提供了巨大的灵活性。</p>
<p>如果您运行<code>Get-Date</code>并且未指定任何参数，该 cmdlet 将返回当前日期和时间。 您可以指定几个参数，以允许您为特定日期创建对象，如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:&gt; <span class="comment"># Using the -Date Parameter and a date string</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="built_in">Get-Date</span> <span class="literal">-Date</span> <span class="string">&#x27;1 August 1942&#x27;</span></span><br><span class="line"><span class="number">01</span> August <span class="number">1942</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Using the -Month, Day, Year to be specific and avoid parsing</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="built_in">Get-Date</span> <span class="literal">-Month</span> <span class="number">8</span> <span class="literal">-Day</span> <span class="number">1</span> <span class="literal">-Year</span> <span class="number">1942</span> <span class="literal">-Hour</span> <span class="number">0</span> <span class="literal">-Minute</span> <span class="number">0</span> <span class="literal">-Second</span> <span class="number">0</span></span><br><span class="line"><span class="number">01</span> August <span class="number">1942</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>您可以查看<code>Get-Date</code>的其他功能以帮助以您需要的确切格式获取日期，请参阅<a target="_blank" rel="noopener" href="https://docs.microsoft.com/powershell/module/microsoft.powershell.utility/get-date?view=powershell-7.1"> Get-Date 帮助信息</a>。</p>
<h3 id="获取昨天的日期-1"><a href="#获取昨天的日期-1" class="headerlink" title="获取昨天的日期"></a>获取昨天的日期</h3><p>如您所见，您可以使用 <code>Get-Date</code> 返回特定日期/时间。 那么你如何得到昨天的日期——或者日期、上个月或去年？ 这里的技巧是使用从 <code>Get-Date</code> 返回的对象。 该对象有一个 <code>System.DateTime</code> 类型，它包含许多方法，允许您向对象添加时间增量——一个月、一天等。</p>
<p>要获取昨天（或明天）的日期，您可以使用不带参数的 <code>Get-Date</code> 创建今天的日期和时间对象。 然后使用 <code>AddDays()</code> 方法添加/减去一些天数，如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:&gt; <span class="comment"># Get today&#x27;s Date</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$Today</span>     = <span class="built_in">Get-Date</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$Yesterday</span> = <span class="variable">$Today</span>.AddDays(<span class="literal">-1</span>)</span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$Yesterday</span></span><br><span class="line"><span class="number">19</span> February <span class="number">2021</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">51</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="comment"># Or more simply</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$Yesterday</span> = (<span class="built_in">Get-Date</span>).AddDays(<span class="literal">-1</span>)</span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$Yesterday</span></span><br><span class="line"><span class="number">19</span> February <span class="number">2021</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">52</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="comment"># Get tomorrow&#x27;s date</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$Tomorrow</span>  = (<span class="built_in">Get-Date</span>).AddDays(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$Tomorrow</span></span><br><span class="line"><span class="number">21</span> February <span class="number">2021</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">54</span></span><br></pre></td></tr></table></figure>

<p>值得注意的是，<code>System.DateTime</code> 对象是不可变的。 这意味着您不能在创建对象后更改属性值。 如果您使用任何 Add 方法，.NET 将返回一个具有新属性值的新对象。</p>
<h3 id="使用昨天的日期"><a href="#使用昨天的日期" class="headerlink" title="使用昨天的日期"></a>使用昨天的日期</h3><p>获取过去(或将来)的日期有多种用例，包括：</p>
<ul>
<li>识别相比这 一天/一个月/etc. 更旧/更新的文件</li>
<li>确定上周未登录的 AD 用户</li>
<li>为表示上周信息的文件创建文件名。</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:&gt; <span class="comment"># Finding files newer than yesterday</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$Yesterday</span> = (<span class="built_in">Get-Date</span>).AddDays(<span class="literal">-1</span>)</span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="built_in">Get-ChildItem</span> | <span class="built_in">Where-Object</span> LastAccessTime <span class="operator">-gt</span> <span class="variable">$Yesterday</span></span><br><span class="line"></span><br><span class="line">    Directory: C:</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line"><span class="literal">-a</span>---          <span class="number">20</span>/<span class="number">02</span>/<span class="number">2021</span>    <span class="number">14</span>:<span class="number">20</span>          <span class="number">11041</span> GratefulDead Show List.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="comment"># Getting users who have logged on in the past day</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> * <span class="literal">-Property</span> LastLogonDate | <span class="built_in">Where-Object</span> LastlogonDate <span class="operator">-gt</span> <span class="variable">$Yesterday</span></span><br><span class="line"></span><br><span class="line">DistinguishedName : CN=Administrator,CN=Users,DC=cookham,DC=net</span><br><span class="line">Enabled           : True</span><br><span class="line">GivenName         : Jerry</span><br><span class="line">LastLogonDate     : <span class="number">20</span>/<span class="number">02</span>/<span class="number">2021</span> <span class="number">04</span>:<span class="number">20</span>:<span class="number">42</span></span><br><span class="line">Name              : Jerry Garcia</span><br><span class="line">ObjectClass       : user</span><br><span class="line">ObjectGUID        : ae31ca0d<span class="literal">-3f01</span><span class="literal">-4eb4</span><span class="literal">-8593</span><span class="literal">-b1d79c71f912</span></span><br><span class="line">SamAccountName    : JerryG</span><br><span class="line">SID               : S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-21</span><span class="literal">-2550804810</span><span class="literal">-443649076</span><span class="literal">-1856842782</span><span class="literal">-500</span></span><br><span class="line">Surname           : Garcia</span><br><span class="line"></span><br><span class="line"><span class="comment"># Creating a file with yesterday&#x27;s date</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="comment"># Creating a file with today&#x27;s date</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$Yesterday</span>     = (<span class="built_in">Get-Date</span>).AddDays(<span class="literal">-1</span>).ToString() <span class="operator">-replace</span> <span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$YesterdayDate</span> = (<span class="variable">$Yesterday</span> <span class="operator">-split</span> <span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="variable">$YesterdayFN</span>   = <span class="string">&quot;Results for <span class="variable">$YesterdayDate</span>.Txt&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:&gt; </span><br><span class="line"><span class="built_in">PS</span> C:&gt; <span class="built_in">New-Item</span> <span class="literal">-Path</span> C:Results <span class="literal">-Name</span>  <span class="variable">$YesterdayFN</span> <span class="literal">-ItemType</span> File</span><br><span class="line"></span><br><span class="line">Directory: C:Results</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line"><span class="literal">-a</span>---          <span class="number">20</span>/<span class="number">02</span>/<span class="number">2021</span>    <span class="number">12</span>:<span class="number">56</span>              <span class="number">0</span> Results <span class="keyword">for</span> <span class="number">19</span><span class="literal">-02</span><span class="literal">-2021</span>.Txt</span><br></pre></td></tr></table></figure>

<p>在最后一个示例中，您需要对 <code>Get-Date</code> 返回的日期/时间进行一些操作，以获得 Windows 接受的文件名。 因为 <code>Get-Date</code> 返回一个字符串，其中包含“/”字符 <code>New-Item</code> 将其作为路径字符。 您可以使用 <code>-Replace</code> 运算符将“/”字符替换为“-”。 此外，在执行替换后，您最终会得到一个（不需要的）时间值。 您可以使用 <code>-Split</code> 运算符只提取日期，这就是您想要的文件名。 一旦你得到了日期，你就可以创建你可以为文件创建一个文件名。</p>
<p>另一种基于 <code>Get-Date</code> 生成文件名的方法是使用 <code>ToString()</code> 方法并指定您想要的确切输出，如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$YesterdayDate</span> = (<span class="built_in">Get-Date</span>).AddDays(<span class="literal">-1</span>).ToString(<span class="string">&#x27;yyyy-MM-dd&#x27;</span>)         </span><br><span class="line"><span class="variable">$YesterdayFN</span>   = <span class="string">&quot;Results for <span class="variable">$YesterdayDate</span>.Txt&quot;</span></span><br></pre></td></tr></table></figure>

<p>另一点值得一提的是 Windows 试图以文艺的方式显示日期。 在大多数情况下，<code>Get-Date</code> 都能很好地将日期字符串转换为您想要的日期。 但是如果你想要一个特定的结果，使用 <code>ToString()</code> 和一个日期格式字符串可能会更好——而且代码行更少。</p>
<p>更不用说，您可以在一行程序中完成所有这些文件名操作。我把这个留作练习。</p>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p>.NET 提供了丰富的日期和时间结构 (<code>System.DateTime</code>)。 此结构包含许多属性，例如给定日期/时间的日、月、小时、毫秒。 您还可以获得多种方法，使您能够通过添加或减去小时、天等来操作日期。您可以使用 <code>Get-Date</code> cmdlet 获取当前日期/时间或特定日期/时间的对象。 <code>Get-Date</code> 返回 <code>System.DateTime</code> 的对象。 您可以使用 <code>System.DateTime</code> 结构的方法来获取相关日期，例如昨天、上个月或前 2 年 42 天和前 32 毫秒。</p>
<h3 id="致敬感谢-1"><a href="#致敬感谢-1" class="headerlink" title="致敬感谢"></a>致敬感谢</h3><p>本文基于Scripting Guys早先的一篇博客文章<a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/scripting/how-can-i-get-yesterdays-date">How can I get yesterday’s date?</a></p>
<h2 id="在新员工PowerShell脚本中利用XML"><a href="#在新员工PowerShell脚本中利用XML" class="headerlink" title="在新员工PowerShell脚本中利用XML"></a>在新员工PowerShell脚本中利用XML</h2><p>我将展示如何利用 XML 文件来引用信息，以帮助增强您的 Active Directory 用户帐户。 这将确保诸如 Outlook 联系人卡片之类的内容是正确的，但也允许您在以后使用此信息，例如 根据办公室位置创建动态通讯组列表，或为建筑物中特定楼层的火灾疏散计划设置 NTFS 权限。 使用 XML 允许不懂 PowerShell 的用户跳入文件并修改或添加地址信息。 意味着脚本中的纯文本字符串更少。</p>
<h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>您有多个子公司，每个子公司都有自己的办公室和地址。 您需要确保您创建的每个新用户都具有基于工作地点的正确地址和联系信息。 虽然在这篇文章中我谈论的是用户帐户，但没有理由不能对计算机帐户或资源应用相同的逻辑。 没有人会喜欢四处打听您 10 分钟前应该在的会议室的位置！</p>
<h3 id="入门-创建XML"><a href="#入门-创建XML" class="headerlink" title="入门 - 创建XML"></a>入门 - 创建XML</h3><p>要创建 xml，我们将使用 <code>XmlWriter</code> 类，将其放入一个变量中以构建并添加一些格式设置选项（这样可以更轻松地查看组信息）。 像这样：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$XMLPath</span> = <span class="string">&quot;C:\Users\sam\AD-References.xml&quot;</span></span><br><span class="line"><span class="variable">$XMLWriter</span> = <span class="built_in">New-Object</span> System.XML.XMlTextWriter(<span class="variable">$XMLPath</span>,<span class="variable">$null</span>)</span><br><span class="line"><span class="variable">$xmlWriter</span>.Formatting = <span class="string">&#x27;Indented&#x27;</span></span><br><span class="line"><span class="variable">$xmlWriter</span>.Indentation = <span class="number">1</span></span><br><span class="line"><span class="variable">$XmlWriter</span>.IndentChar = <span class="string">&quot;`t&quot;</span></span><br></pre></td></tr></table></figure>

<p>运行上面的命令，我们会得到一个新的 xml 源文件，里面什么都没有； 我们已经准备好充实它。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># write the header</span></span><br><span class="line"><span class="variable">$xmlWriter</span>.WriteStartDocument()</span><br><span class="line"><span class="comment"># set XSL statements</span></span><br><span class="line"><span class="variable">$xmlWriter</span>.WriteProcessingInstruction(<span class="string">&quot;xml-stylesheet&quot;</span>, <span class="string">&quot;type=&#x27;text/xsl&#x27; href=&#x27;style.xsl&#x27;&quot;</span>)</span><br><span class="line"><span class="variable">$XMLWriter</span>.WriteStartElement(<span class="string">&#x27;Companies&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>现在我们有进展了。我们已经启动了我们的公司元素。让我们创建一个公司，并在下面添加一些办公室信息。然后我们将完成XML文档。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start Company 1</span></span><br><span class="line"><span class="variable">$XMLWriter</span>.WriteStartElement(<span class="string">&#x27;Company-1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Birmingham Office</span></span><br><span class="line"><span class="variable">$xmlWriter</span>.WriteStartElement(<span class="string">&#x27;Birmingham&#x27;</span>)</span><br><span class="line"><span class="variable">$XmlWriter</span>.WriteElementString(<span class="string">&#x27;Street&#x27;</span>, <span class="string">&#x27;Unit 77, 132 Dummy Lane&#x27;</span>)</span><br><span class="line"><span class="variable">$XmlWriter</span>.WriteElementString(<span class="string">&#x27;City&#x27;</span>, <span class="string">&#x27;Birmingham&#x27;</span>)</span><br><span class="line"><span class="variable">$XMLWriter</span>.WriteElementString(<span class="string">&#x27;State&#x27;</span>, <span class="string">&#x27;Staffordshire&#x27;</span>)</span><br><span class="line"><span class="variable">$XMLWriter</span>.WriteElementString(<span class="string">&#x27;Postcode&#x27;</span>, <span class="string">&#x27;B1 1BB&#x27;</span>)</span><br><span class="line"><span class="variable">$XMLWriter</span>.WriteElementString(<span class="string">&#x27;Country&#x27;</span>, <span class="string">&#x27;GB&#x27;</span>)</span><br><span class="line"><span class="variable">$XMLWriter</span>.WriteEndElement()</span><br><span class="line"></span><br><span class="line"><span class="comment">#End Company 1</span></span><br><span class="line"><span class="variable">$XMLWriter</span>.WriteEndElement()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Finish up document</span></span><br><span class="line"><span class="variable">$XMLWriter</span>.WriteEndElement()</span><br><span class="line"><span class="variable">$xmlWriter</span>.WriteEndDocument()</span><br><span class="line"><span class="variable">$xmlWriter</span>.Flush()</span><br><span class="line"><span class="variable">$xmlWriter</span>.Close()</span><br></pre></td></tr></table></figure>

<p>让我们在运行这段代码后查看完成的XML。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><br><span class="line">&lt;?xml<span class="literal">-stylesheet</span> <span class="built_in">type</span>=<span class="string">&#x27;text/xsl&#x27;</span> href=<span class="string">&#x27;style.xsl&#x27;</span>?&gt;</span><br><span class="line">&lt;Companies&gt;</span><br><span class="line">    &lt;Company<span class="literal">-1</span>&gt;</span><br><span class="line">        &lt;Birmingham&gt;</span><br><span class="line">            &lt;Street&gt;Unit <span class="number">77</span>, <span class="number">132</span> Dummy Lane&lt;/Street&gt;</span><br><span class="line">            &lt;City&gt;Birmingham&lt;/City&gt;</span><br><span class="line">            &lt;State&gt;Staffordshire&lt;/State&gt;</span><br><span class="line">            &lt;Postcode&gt;B1 <span class="number">1</span>BB&lt;/Postcode&gt;</span><br><span class="line">            &lt;Country&gt;GB&lt;/Country&gt;</span><br><span class="line">        &lt;/Birmingham&gt;</span><br><span class="line">    &lt;/Company<span class="literal">-1</span>&gt;</span><br><span class="line">&lt;/Companies&gt;</span><br></pre></td></tr></table></figure>

<h3 id="PowerShell-使用XML"><a href="#PowerShell-使用XML" class="headerlink" title="PowerShell - 使用XML"></a>PowerShell - 使用XML</h3><p>现在我们有了一些可用于 PowerShell 的可用数据。 您可以为创建用户的办公室/公司添加更多元素。 接下来如何引用它就很清楚了。</p>
<p>提示：将您的 XML 创建脚本保存在与引用它的脚本相同的位置； 这使得路径变量更容易，如果 xml 丢失，也方便您快速创建它。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Load up the XML for reference later, if it&#x27;s been deleted recreate it using the creation script.</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$XMLPath</span> = <span class="string">&quot;<span class="variable">$PSScriptRoot</span>\AD-References.xml&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Test-Path</span> <span class="variable">$XMLPath</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$XML</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> XML</span><br><span class="line">        <span class="variable">$XML</span> = [<span class="built_in">XML</span>] (<span class="built_in">Get-Content</span> <span class="variable">$XMLPath</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">Start-Process</span> <span class="string">&quot;<span class="variable">$PSScriptRoot</span>\Write-XML.ps1&quot;</span> <span class="literal">-Wait</span></span><br><span class="line">        <span class="variable">$XML</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> XML</span><br><span class="line">        <span class="variable">$XML</span> = [<span class="built_in">XML</span>] (<span class="built_in">Get-Content</span> <span class="variable">$XMLPath</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在这里，我们正在测试 XML 的路径，如果不存在，则再次运行创建脚本。 然后，我们将其加载到一个变量中以供调用。</p>
<p>我们可以通过使用 <code>Read-Host</code> 和一些附加的验证来为新用户收集信息。 像这样：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">ValidatePattern</span>(<span class="string">&quot;\w+&quot;</span>)]<span class="variable">$FirstName</span> = <span class="built_in">Read-Host</span> <span class="literal">-Prompt</span> <span class="string">&quot;Please input users first name&quot;</span></span><br><span class="line">[<span class="type">ValidatePattern</span>(<span class="string">&quot;\w+&quot;</span>)]<span class="variable">$LastName</span> = <span class="built_in">Read-Host</span> <span class="literal">-Prompt</span> <span class="string">&quot;Please input users last name&quot;</span></span><br><span class="line">[<span class="type">ValidatePattern</span>(<span class="string">&quot;\w+&quot;</span>)]<span class="variable">$Company</span> = <span class="built_in">Read-Host</span> <span class="literal">-Prompt</span> <span class="string">&quot;Please input users company&quot;</span></span><br><span class="line">[<span class="type">ValidatePattern</span>(<span class="string">&quot;\w+&quot;</span>)]<span class="variable">$Office</span> = <span class="built_in">Read-Host</span> <span class="literal">-Prompt</span> <span class="string">&quot;Please input users office&quot;</span></span><br></pre></td></tr></table></figure>

<p>十分简单。 4 个问题和 4 个答案，分为 4 个变量。 与其问很多问题来查找邮政编码或国家/地区等信息，不如使用我们的 XML！</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Declare some more variables</span></span><br><span class="line"><span class="variable">$FirstInitial</span> = <span class="string">&quot;<span class="variable">$FirstName</span>.substring(0,1)&quot;</span></span><br><span class="line"><span class="variable">$Path</span> = <span class="string">&#x27;OU=Users,OU=Contoso,DC=Contoso,DC=com&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build hashtable of new user parameters</span></span><br><span class="line">  <span class="variable">$NewUserParams</span> =<span class="selector-tag">@</span>&#123;</span><br><span class="line">        GivenName = <span class="variable">$FirstName</span></span><br><span class="line">        Name = <span class="string">&quot;<span class="variable">$FirstName</span> <span class="variable">$LastName</span>&quot;</span></span><br><span class="line">        Surname = <span class="variable">$LastName</span></span><br><span class="line">        SamAccountName = <span class="string">&quot;<span class="variable">$FirstInitial</span> + <span class="variable">$LastName</span>&quot;</span></span><br><span class="line">        DisplayName = <span class="string">&quot;<span class="variable">$FirstName</span> <span class="variable">$LastName</span>&quot;</span></span><br><span class="line">        UserPrincipalName = <span class="string">&quot;<span class="variable">$userName</span>&quot;</span> + <span class="string">&quot;@&quot;</span> + <span class="string">&quot;contoso.com&quot;</span></span><br><span class="line">        AccountPassword = <span class="variable">$password</span></span><br><span class="line">        Office = <span class="variable">$Office</span></span><br><span class="line">        StreetAddress = (<span class="variable">$XML</span>.Companies.<span class="variable">$Company</span>.<span class="variable">$office</span>.Street).Trim()</span><br><span class="line">        PostalCode = (<span class="variable">$XML</span>.Companies.<span class="variable">$Company</span>.<span class="variable">$Office</span>.Postcode).Trim()</span><br><span class="line">        City = (<span class="variable">$XML</span>.Companies.<span class="variable">$Company</span>.<span class="variable">$Office</span>.City).Trim()</span><br><span class="line">        State = (<span class="variable">$XML</span>.Companies.<span class="variable">$Company</span>.<span class="variable">$Office</span>.State).Trim()</span><br><span class="line">        Country = (<span class="variable">$XML</span>.Companies.<span class="variable">$Company</span>.<span class="variable">$Office</span>.Country).Trim()</span><br><span class="line">        Path = <span class="variable">$Path</span></span><br><span class="line">        ChangePasswordAtLogon = <span class="variable">$false</span></span><br><span class="line">        Enabled = <span class="variable">$true</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># Create the user</span></span><br><span class="line"><span class="built_in">New-ADUser</span> @NewUserParams</span><br></pre></td></tr></table></figure>

<p>就这么简单，使用点符号浏览 xml 元素，并去掉不需要的空格。 为方便起见，简单处理如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">StreetAddress = (<span class="variable">$XML</span>.Companies.<span class="variable">$Company</span>.<span class="variable">$Office</span>.Street).Trim()</span><br><span class="line">PostalCode = (<span class="variable">$XML</span>.Companies.<span class="variable">$Company</span>.<span class="variable">$Office</span>.Postcode).Trim()</span><br><span class="line">City = (<span class="variable">$XML</span>.Companies.<span class="variable">$Company</span>.<span class="variable">$Office</span>.City).Trim()</span><br><span class="line">State = (<span class="variable">$xml</span>.Companies.<span class="variable">$Company</span>.<span class="variable">$Office</span>.State).Trim()</span><br><span class="line">Country = (<span class="variable">$xml</span>.Companies.<span class="variable">$Company</span>.<span class="variable">$Office</span>.Country).Trim()</span><br></pre></td></tr></table></figure>

<h3 id="有用的笔记"><a href="#有用的笔记" class="headerlink" title="有用的笔记"></a>有用的笔记</h3><ul>
<li>在创建XML元素时要小心!不允许有空格!如果XML元素中有空格，您将得到XML Writer错误。我用-来代替空格。</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$XMLWriter</span>.WriteStartElement(<span class="string">&#x27;Company-1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>您使用 <code>Read-Host</code> 输入的变量需要与 XML 中的元素名称相匹配。 您可以使用验证脚本来验证您的输入。 这是<a target="_blank" rel="noopener" href="https://adamtheautomator.com/powershell-validatescript">与验证输入有关的所有内容</a>的有用读物。</li>
</ul>
<h3 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h3><p>您真的可以进一步充实这一点，并将大量信息加载到 XML 中以供调用，例如 公司项目信息，可以添加用户的 AD 组集，管理书签 URL（然后复制到注册表项中）。</p>
<h2 id="如何判断一个用户是本地管理员"><a href="#如何判断一个用户是本地管理员" class="headerlink" title="如何判断一个用户是本地管理员"></a>如何判断一个用户是本地管理员</h2><p>问题：我们在登录脚本中执行的某些操作要求用户是本地管理员。 脚本如何使用 PowerShell 7 判断用户是否是本地管理员。</p>
<p>解答：简单，使用 PowerShell 7 和 LocalAccounts 模块。</p>
<h3 id="本地用户和组"><a href="#本地用户和组" class="headerlink" title="本地用户和组"></a>本地用户和组</h3><p>让我们先从回顾 Windows 中的本地用户和组开始吧。</p>
<p>除了域控制器之外，每个 Windows 系统都维护一组本地帐户——本地用户和本地组。 域控制器使用 AD，并没有真正的本地帐户。 在设置权限时，除了加入域的主机上的域用户和域组之外，您还可以使用这些本地帐户。 您可以使用本地帐户或域帐户登录到给定的服务器。 在域控制器上，您只能使用域帐户登录。</p>
<p>与 AD 组一样，本地组和本地用户各有一个唯一的安全 ID (SID)。 当您授予本地用户或组访问文件或文件夹的权限时，Windows 会将该 SID 添加到对象的访问控制列表中。 这与 Windows 允许您将本地文件或文件夹的权限授予任何 Active Directory 用户或组的方式相同。</p>
<p>此外，Windows 和某些 Windows 功能会创建“众所周知的”本地组。 目的是将用户添加到这些组中，以使这些用户能够仅在这些服务器上执行特定的管理功能。</p>
<p>旧方法，您可能已经将 <code>Wscript.Network</code> COM 对象与 ADSI 结合使用。 当然，您可以在 PowerShell 7 中使用旧方法，但何必呢？ PowerShell 7 的好消息是，您可以使用 <code>Microsoft.PowerShell.LocalAccounts</code> 模块来管理本地帐户。 在撰写本文时，这是一个 Windows-only 的模块（非跨平台模块）。</p>
<h3 id="Microsoft-PowerShell-LocalAccounts模块"><a href="#Microsoft-PowerShell-LocalAccounts模块" class="headerlink" title="Microsoft.PowerShell.LocalAccounts模块"></a>Microsoft.PowerShell.LocalAccounts模块</h3><p>在 PowerShell 7 for Windows 中，您可以使用 <code>Microsoft.PowerShell.LocalAccounts</code> 模块来管理本地用户和组。 该模块是 PowerShell 7 从 <code>C:\WINDOWS\system32\WindowsPowerShell\v1.0\Modules\Microsoft.PowerShell.LocalAccounts</code> 加载的 Windows PowerShell 模块。</p>
<p>该模块包含 15 个 cmdlet，您可以这样查看：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span>&gt; <span class="built_in">Get-Command</span> <span class="literal">-Module</span> Microsoft.PowerShell.LocalAccounts</span><br><span class="line"></span><br><span class="line">CommandType     Name                       Version    Source</span><br><span class="line">-----------     ----                       -------    ------</span><br><span class="line">Cmdlet          <span class="built_in">Add-LocalGroupMember</span>       <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Disable-LocalUser</span>          <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Enable-LocalUser</span>           <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Get-LocalGroup</span>             <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Get-LocalGroupMember</span>       <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Get-LocalUser</span>              <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">New-LocalGroup</span>             <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">New-LocalUser</span>              <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Remove-LocalGroup</span>          <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Remove-LocalGroupMember</span>    <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Remove-LocalUser</span>           <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Rename-LocalGroup</span>          <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Rename-LocalUser</span>           <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Set-LocalGroup</span>             <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br><span class="line">Cmdlet          <span class="built_in">Set-LocalUser</span>              <span class="number">1.0</span>.<span class="number">0.0</span>    Microsoft.PowerShell.LocalAccounts</span><br></pre></td></tr></table></figure>

<p>如您所知，这些 cmdlet 允许您添加、删除、更改、启用和禁用本地用户或本地组，并且它们允许您添加、删除和获取本地组的成员。 这些 cmdlet 与 ActiveDirectory cmdlet 大致相似，但适用于本地用户。 如上所述，如果您愿意或需要，您可以将域用户/组用作本地组的成员。</p>
<p>您可以使用 <code>Get-LocalGroupMember</code> 命令查看本地组的成员，如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span>&gt; <span class="built_in">Get-LocalGroupMember</span> <span class="literal">-Group</span> <span class="string">&#x27;Administrators&#x27;</span></span><br><span class="line"></span><br><span class="line">ObjectClass Name                     PrincipalSource</span><br><span class="line">----------- ----                     ---------------</span><br><span class="line"><span class="built_in">Group</span>       COOKHAM\Domain Admins    ActiveDirectory</span><br><span class="line">User        COOKHAM24\Administrator  Local</span><br><span class="line">User        COOKHAM\JerryG           ActiveDirectory</span><br><span class="line">User        COOKHAM24\Dave           Local</span><br></pre></td></tr></table></figure>

<p>正如您在此输出中看到的，此主机上的本地管理员组包含域用户和组以及本地用户。</p>
<h3 id="用户是否为管理员"><a href="#用户是否为管理员" class="headerlink" title="用户是否为管理员"></a>用户是否为管理员</h3><p>如上所示，获取任何本地组的成员很容易。 但是，如果您想知道给定用户是否是某个本地管理组的成员怎么办？ 这也很简单，只需几步即可。 获取当前用户名称的一种方法是使用 whoami.exe。 然后你可以获取本地管理员组的成员。 最后，您检查当前登录的用户是否是该组的成员。 所有这些看起来像这样：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span>&gt; <span class="comment"># Get who I am</span></span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="variable">$Me</span> = whoami.exe</span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="variable">$Me</span> </span><br><span class="line">Cookham\JerryG</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="comment"># Get members of administrators group</span></span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="variable">$Admins</span> = <span class="built_in">Get-LocalGroupMember</span> <span class="literal">-Name</span> Administrators | </span><br><span class="line">       <span class="built_in">Select-Object</span> <span class="literal">-ExpandProperty</span> name</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="comment"># Check to see if this user is an administrator and act accordingly</span></span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="keyword">if</span> (<span class="variable">$Admins</span> <span class="operator">-Contains</span> <span class="variable">$Me</span>) &#123;<span class="string">&quot;<span class="variable">$Me</span> is a local administrator&quot;</span>&#125; <span class="keyword">else</span> &#123;<span class="string">&quot;<span class="variable">$Me</span> is NOT a local administrator&quot;</span>&#125;</span><br><span class="line">Cookham\JerryG is a local administrator</span><br></pre></td></tr></table></figure>

<p>如果管理组包含运行脚本的用户，则 $Me 是该本地管理组中的用户。</p>
<p>在这篇文章中，我们只是回应了一个事实，即用户是不是本地管理员组的成员。 您可以调整它以确保用户在尝试运行某些命令之前是适当组的成员。 您还可以调整它以检查其他本地组的成员身份，例如可能相关的 Backup Operators 或 Hyper-V Users。</p>
<p>在您的登录脚本中，一旦您知道该用户是本地管理组的成员，您就可以执行任何需要该成员资格的任务。 如果用户不是该组的成员，您可以回应这一事实，并避免使用相关的 cmdlet。</p>
<h3 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h3><p>使用PowerShell 7中的本地账户模块，轻松管理本地用户组！ 当然，您可以在 Windows PowerShell 中以相同的方式管理其他组。</p>
<h3 id="致敬"><a href="#致敬" class="headerlink" title="致敬"></a>致敬</h3><p>本文最初是一个基于VBS的解决方案，如之前的<a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/scripting/how-can-i-determine-if-a-user-is-a-local-administrator/">博客文章</a>所述。我不知道原帖子的作者是谁，但是谢谢。</p>
<h2 id="在-Active-Directory-中测试与计算机的连接"><a href="#在-Active-Directory-中测试与计算机的连接" class="headerlink" title="在 Active Directory 中测试与计算机的连接"></a>在 Active Directory 中测试与计算机的连接</h2><p>问题：作为管理员，我经常需要对我域中的服务器进行大量报告。 是否有一种简单的方法来测试与我的域中的每台服务器或特定 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/195737#h2-11">OU</a> 中的每台服务器或客户端主机的连接？</p>
<p>解答：您当然可以使用 PowerShell 来做到这一点！ 您可以使用 <code>ActiveDirectory</code> cmdlet 和 <code>Test-Connection</code>，尽管它并不像人们想象的那么简单。</p>
<h3 id="使用ActiveDirectory模块"><a href="#使用ActiveDirectory模块" class="headerlink" title="使用ActiveDirectory模块"></a>使用ActiveDirectory模块</h3><p>Microsoft 开发了多个模块来帮助您在组织中或通过 Azure 部署和管理 AD。 <code>ActiveDirectory</code> 模块是 Microsoft 随 Windows Server 一起提供的模块（尽管默认情况下未安装）。 您还可以在 Windows 10 主机上为 AD 加载Remote Server Administration (RSAT) 模块。 RSAT 模块允许您使用 PowerShell 从远程计算机管理 AD。 有关 <code>ActiveDirectory</code> 模块的更多详细信息，请参阅 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/powershell/module/addsadministration/">ActiveDirectory</a> 模块文档。</p>
<p>使用 <code>Get-ADComputer</code> 帐户返回有关 AD 中部分或所有计算机的详细信息。 有多种方法可以使用 <code>Get-ADComputer</code> 来获取您想要的计算机帐户以及您需要的任何属性。 其中包括使用 <strong>Identity</strong> 和 <strong>Filter</strong> 参数。</p>
<p><code>Get-ADComputer</code> 返回的每个计算机帐户都包含两个重要属性：<strong>Name</strong> 和 <strong>DNSHostName</strong>。 <strong>Name</strong> 属性是计算机的单标签名称（又名 NetBIOS 名称）。 <strong>DNSHostName</strong> 属性是计算机的完全限定 DNS 名称（FQDN）。 像这样：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span>&gt; <span class="built_in">Get-ADComputer</span> <span class="literal">-Filter</span> * | <span class="built_in">Format-Table</span> <span class="literal">-Property</span> Name, DNSHostName</span><br><span class="line"></span><br><span class="line">Name         DNSHostName</span><br><span class="line">----         -----------</span><br><span class="line">COOKHAM1     Cookham1.cookham.net</span><br><span class="line">win10lt      Win10LT.cookham.net</span><br><span class="line">cookham24    cookham24.cookham.net</span><br><span class="line">SLTPC        sltpc.cookham.net</span><br><span class="line">COOKHAM4LTDC Cookham4LTDC.cookham.net</span><br></pre></td></tr></table></figure>

<p>因此，您可能会认为测试与每台计算机的连接很简单。 您将 <code>Get-ADComputer</code> 的输出通过管道传输到 <code>Test-Connection</code>，它就可以正常工作。 可悲的是，事情并不是那么简单。</p>
<p>如果您尝试这样做，您会看到以下内容：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span>&gt; <span class="built_in">Get-ADComputer</span> <span class="literal">-Filter</span> * | <span class="built_in">Test-Connection</span></span><br><span class="line"><span class="built_in">Test-Connection</span>: Cannot validate argument on <span class="keyword">parameter</span> <span class="string">&#x27;TargetName&#x27;</span>. The argument is null, empty, or an element of the argument collection contains a null value. Supply a collection that does not contain any null values and then <span class="keyword">try</span> the command again.</span><br><span class="line"><span class="built_in">Test-Connection</span>: Cannot validate argument on <span class="keyword">parameter</span> <span class="string">&#x27;TargetName&#x27;</span>. The argument is null, empty, or an element of the argument collection contains a null value. Supply a collection that does not contain any null values and then <span class="keyword">try</span> the command again.</span><br><span class="line"><span class="built_in">Test-Connection</span>: Cannot validate argument on <span class="keyword">parameter</span> <span class="string">&#x27;TargetName&#x27;</span>. The argument is null, empty, or an element of the argument collection contains a null value. Supply a collection that does not contain any null values and then <span class="keyword">try</span> the command again.</span><br><span class="line"><span class="built_in">Test-Connection</span>: Cannot validate argument on <span class="keyword">parameter</span> <span class="string">&#x27;TargetName&#x27;</span>. The argument is null, empty, or an element of the argument collection contains a null value. Supply a collection that does not contain any null values and then <span class="keyword">try</span> the command again.</span><br><span class="line"><span class="built_in">Test-Connection</span>: Cannot validate argument on <span class="keyword">parameter</span> <span class="string">&#x27;TargetName&#x27;</span>. The argument is null, empty, or an element of the argument collection contains a null value. Supply a collection that does not contain any null values and then <span class="keyword">try</span> the command again.</span><br></pre></td></tr></table></figure>

<p>这是怎么回事？</p>
<h3 id="属性-Property-参数-Parameter-未对齐"><a href="#属性-Property-参数-Parameter-未对齐" class="headerlink" title="属性(Property)/参数(Parameter) 未对齐"></a>属性(Property)/参数(Parameter) 未对齐</h3><p>我们这里有一个经典的，尽管相对不常见的情况。 <code>Test-Connection</code> cmdlet 使用参数名称 <strong>Target</strong> 来指示要测试连接的计算机。 但是，在此流水线命令中，<code>Get-ADComputer</code> 生成的对象不包含该名称的属性。 相反，这些对象具有名为 <strong>Name</strong> 和 <strong>DNSHostName</strong> 的属性。</p>
<p>提示：</p>
<p>在 Windows PowerShell 中，您使用参数 <strong>ComputerName</strong> 来指示您正在调查的计算机。 在 PowerShell 7 中，开发人员已将此参数名称更改为 <strong>TargetName</strong>。 为了获得最佳兼容性，该 cmdlet 定义了此参数的别名<strong>ComputerName</strong>。 此 cmdlet 允许您将 <strong>TargetName</strong> 或 <strong>Computername</strong> 与 <code>Test-Connection</code> 结合使用。</p>
<h3 id="ForEach-Object-来解决问题"><a href="#ForEach-Object-来解决问题" class="headerlink" title="ForEach-Object 来解决问题"></a>ForEach-Object 来解决问题</h3><p>解决这个参数/属性对齐问题非常容易。 您可以使用 <code>Foreach-Object</code> cmdlet，如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span>&gt; <span class="built_in">Get-ADComputer</span> <span class="literal">-Filter</span> * | </span><br><span class="line">             <span class="built_in">ForEach-Object</span> &#123;<span class="string">&quot;<span class="variable">$_</span>&quot;</span>;<span class="built_in">Test-Connection</span> <span class="literal">-TargetName</span> <span class="variable">$_</span>.Name;<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">CN=COOKHAM1,OU=Domain Controllers,DC=cookham,DC=net</span><br><span class="line">   Destination: COOKHAM1</span><br><span class="line">Ping Source      Address      Latency BufferSize Status</span><br><span class="line">                                 (ms)        (B)</span><br><span class="line">---- ------      -------      ------- ---------- ------</span><br><span class="line">   <span class="number">1</span> cookham24   <span class="number">10.10</span>.<span class="number">10.9</span>         <span class="number">0</span>         <span class="number">32</span> Success</span><br><span class="line">   <span class="number">2</span> cookham24   <span class="number">10.10</span>.<span class="number">10.9</span>         <span class="number">0</span>         <span class="number">32</span> Success</span><br><span class="line">   <span class="number">3</span> cookham24   <span class="number">10.10</span>.<span class="number">10.9</span>         <span class="number">0</span>         <span class="number">32</span> Success</span><br><span class="line">   <span class="number">4</span> cookham24   <span class="number">10.10</span>.<span class="number">10.9</span>         <span class="number">0</span>         <span class="number">32</span> Success</span><br><span class="line"></span><br><span class="line">CN=win10lt,OU=CookhamHQ,DC=cookham,DC=net</span><br><span class="line">   Destination: win10lt</span><br><span class="line">Ping Source      Address          Latency BufferSize Status</span><br><span class="line">                                     (ms)        (B)</span><br><span class="line">---- ------      -------          ------- ---------- ------</span><br><span class="line">   <span class="number">1</span> cookham24   *                      <span class="number">0</span>         <span class="number">32</span> DestinationHost…</span><br><span class="line">   <span class="number">2</span> cookham24   *                      <span class="number">0</span>         <span class="number">32</span> DestinationHost…</span><br><span class="line">   <span class="number">3</span> cookham24   *                      <span class="number">0</span>         <span class="number">32</span> DestinationHost…</span><br><span class="line">   <span class="number">4</span> cookham24   *                      <span class="number">0</span>         <span class="number">32</span> DestinationHost…</span><br><span class="line"></span><br><span class="line">CN=SLTPC,CN=Computers,DC=cookham,DC=net</span><br><span class="line">   Destination: SLTPC</span><br><span class="line">Ping Source      Address                   Latency BufferSize Status</span><br><span class="line">                                              (ms)        (B)</span><br><span class="line">|---- ------      -------                   ------- ---------- ------</span><br><span class="line">   <span class="number">1</span> cookham24   <span class="number">2</span>a02:<span class="number">8010</span>:<span class="number">6386</span>:<span class="number">0</span>:f810:<span class="number">2</span>b…       <span class="number">1</span>         <span class="number">32</span> Success</span><br><span class="line">   <span class="number">2</span> cookham24   <span class="number">2</span>a02:<span class="number">8010</span>:<span class="number">6386</span>:<span class="number">0</span>:f810:<span class="number">2</span>b…       <span class="number">0</span>         <span class="number">32</span> Success</span><br><span class="line">   <span class="number">3</span> cookham24   <span class="number">2</span>a02:<span class="number">8010</span>:<span class="number">6386</span>:<span class="number">0</span>:f810:<span class="number">2</span>b…       <span class="number">0</span>         <span class="number">32</span> Success</span><br><span class="line">   <span class="number">4</span> cookham24   <span class="number">2</span>a02:<span class="number">8010</span>:<span class="number">6386</span>:<span class="number">0</span>:f810:<span class="number">2</span>b…       <span class="number">3</span>         <span class="number">32</span> Success</span><br><span class="line">etc</span><br></pre></td></tr></table></figure>

<h3 id="使用可扩展类型系统"><a href="#使用可扩展类型系统" class="headerlink" title="使用可扩展类型系统"></a>使用可扩展类型系统</h3><p>如果您计划进行大量此类工作，则有一种更直接的方法可以解决这个属性/参数对齐问题。 您可以使用可扩展类型系统 (Extensible Type System，ETS) 扩展任何 AD 计算机对象以包含 Name 或 DNSHostName 属性的别名。 您可以通过一个小的 XML 文件定义此扩展，然后导入该文件，如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span>&gt; <span class="built_in">Get-Content</span> <span class="string">&#x27;.aaatypes.types.ps1xml&#x27;</span></span><br><span class="line">&lt;Types&gt;</span><br><span class="line"> &lt;<span class="built_in">Type</span>&gt;</span><br><span class="line">    &lt;Name&gt;Microsoft.ActiveDirectory.Management.ADComputer&lt;/Name&gt;</span><br><span class="line">    &lt;Members&gt;</span><br><span class="line">       &lt;AliasProperty&gt;</span><br><span class="line">          &lt;Name&gt;TargetName&lt;/Name&gt;</span><br><span class="line">          &lt;ReferencedMemberName&gt;DNSHostName&lt;/ReferencedMemberName&gt;</span><br><span class="line">         &lt;/AliasProperty&gt;</span><br><span class="line">    &lt;/Members&gt;</span><br><span class="line">  &lt;/<span class="built_in">Type</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;/Types&gt;</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="built_in">Update-TypeData</span> <span class="literal">-PrependPath</span> .aaatypes.types.ps1xml</span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="built_in">Get-ADComputer</span> <span class="literal">-Identity</span> Cookham1 | <span class="built_in">Test-Connection</span></span><br><span class="line"></span><br><span class="line">   Destination: Cookham1.cookham.net</span><br><span class="line"></span><br><span class="line">Ping Source           Address                   Latency BufferSize Status</span><br><span class="line">                                                   (ms)        (B)</span><br><span class="line">---- ------           -------                   ------- ---------- ------</span><br><span class="line">   <span class="number">1</span> cookham24        <span class="number">10.10</span>.<span class="number">10.9</span>                      <span class="number">0</span>         <span class="number">32</span> Success</span><br><span class="line">   <span class="number">2</span> cookham24        <span class="number">10.10</span>.<span class="number">10.9</span>                      <span class="number">0</span>         <span class="number">32</span> Success</span><br><span class="line">   <span class="number">3</span> cookham24        <span class="number">10.10</span>.<span class="number">10.9</span>                      <span class="number">0</span>         <span class="number">32</span> Success</span><br><span class="line">   <span class="number">4</span> cookham24        <span class="number">10.10</span>.<span class="number">10.9</span>                      <span class="number">0</span>         <span class="number">32</span> Success</span><br></pre></td></tr></table></figure>

<p>您可以通过将 <code>Update-TypeData</code> 添加到您的 PowerShell 配置文件来保留此 ETS 扩展。 这样，每次启动 PowerShell 会话时，该 ETS 扩展就已就位并准备好为您提供帮助。</p>
<p>有关 ETS 的详细信息和背景，请参阅<a target="_blank" rel="noopener" href="https://docs.microsoft.com/powershell/scripting/developer/ets/overview">扩展类型系统概述</a>。</p>
<h3 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h3><p><code>Get-ADComputer</code> cmdlet 生成的对象的属性在管道方面未被对象开发人员与 <code>Test-Connection</code> 对齐。 有一个简单的方法可以解决这个问题，即使用 <code>For-EachObject</code>，尽管它需要更多的输入。 您还可以使用 ETS 扩展 <strong>ADComputer</strong> 对象以获得更友好的别名。</p>
<h3 id="致敬-1"><a href="#致敬-1" class="headerlink" title="致敬"></a>致敬</h3><p>本文基于此博客问题队列中的请求，请参阅帖子<a target="_blank" rel="noopener" href="https://github.com/PowerShell/Community-Blog/issues/21">请求 – 如何获取域中所有活动的服务器？</a>。</p>
<h2 id="如何监控-AD-组成员的变化"><a href="#如何监控-AD-组成员的变化" class="headerlink" title="如何监控 AD 组成员的变化"></a>如何监控 AD 组成员的变化</h2><p>问题：是否有一种简单的方法来检测和更改重要的 AD 组成员？</p>
<p>解答：使用 PowerShell 7、WMI 和 CIM Cmdlet。</p>
<h3 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h3><p>Windows Management Instrumentation (WMI) 是 Windows 操作系统的重要组成部分。 WMI 是基于 Windows 的计算机上的管理数据和管理操作的基础结构。 您可以使用 PowerShell 检索有关主机的信息，例如 BIOS 序列号。 此外，您还可以执行管理操作，例如创建 SMB 共享。</p>
<p>在许多情况下，WMI 只是另一种做事的方式。 例如，您可以使用 WMI 通过使用 <strong>Win32_Share</strong> 类的 <code>Create</code> 方法来创建 SMB 共享。 有关详细信息，请参阅 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/windows/win32/cimwin32prov/win32-share">Win32_Share 类</a>的文档页面。 在大多数情况下，您使用 PowerShell cmdlet（例如 SMB cmdlet）来管理您的 SMB 共享。 WMI 的价值在于它可以让您访问更多使用 cmdlet 无法访问的信息和功能。</p>
<p>在撰写本文时，我假设您了解 WMI。 具体而言，我假设您了解 WMI 命名空间、类、属性和方法。 如果没有，您可能想查看 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/windows/win32/wmisdk/wmi-start-page">WMI 文档</a>。</p>
<h3 id="WMI-事件"><a href="#WMI-事件" class="headerlink" title="WMI 事件"></a>WMI 事件</h3><p>WMI 的一个很酷且非常强大的功能是事件处理。 使用 WMI 事件，您可以订阅一个事件，例如 AD 组成员的更改。 如果发生该事件，您可以采取一些措施，例如写入日志文件或发送电子邮件。 WMI 事件处理相当简单且非常强大——如果您知道要使用哪些类以及如何使用它们！</p>
<p>WMI 中有两大类事件。 通过临时事件，您可以在 PowerShell 会话中使用 PowerShell 来订阅事件并处理它们。 如果关闭该会话，事件订阅和事件处理程序将丢失。 要使临时 WMI 事件持续监视，您必须使主机保持打开状态并登录，这并不是最优解。 临时事件很适合处理故障排除，但不适合长期监控。</p>
<p>通过永久事件处理，您也需要告诉 WMI 要处理什么事件以及在事件发生时要做什么。 为此，要将事件处理的详细信息添加到 WMI 存储库。 这样 WMI 可以在关闭会话、注销甚至重新启动主机后继续监视事件。 借助 PowerShell 和 PowerShell 远程处理，可以非常轻松地在多台服务器上部署 WMI 事件检测。</p>
<p>需要提醒你，wmi事件文档可能不会覆盖所有情况。 一些文档专注于开发人员，因此缺少很好的 PowerShell 示例。</p>
<h3 id="永久事件消费者"><a href="#永久事件消费者" class="headerlink" title="永久事件消费者"></a>永久事件消费者</h3><p>在 WMI 中，永久事件使用者是一个内置的 COM 组件，它在任何给定事件发生时执行某些操作。 从理论上讲，我想您可以开发一个私有 WMI 事件使用者，但我从未见过有人开发过。 当然，我并不是说没有人做过。 如果你看到了这个——请发表评论，因为我很想看到代码并理解细节。</p>
<p>Microsoft 在 Windows 中提供了五个关键的 WMI 永久事件消费者：</p>
<ul>
<li><strong>Active Script Consumer</strong>：可以使用它来运行特定的 VBS 脚本。</li>
<li><strong>Log File Consumer</strong>：将可自定义文本的字符串写入文本文件。</li>
<li><strong>NT Event Log Consumer</strong>：将事件详细信息写入 Windows 应用程序事件日志。</li>
<li><strong>SMTP Event Consumer</strong>：在事件发生时发送 SMTP 电子邮件消息</li>
<li><strong>Command Line Consumer</strong>：运行带有参数的程序，例如运行PowerShell 7 并指定要运行的脚本。</li>
</ul>
<p><strong>Active Script Consumer</strong> 仅运行 VBS 脚本。 如果不重新开发 COM 组件，您不能将此 Consumer 与 Powershell 脚本一起使用。 <strong>Log File Consumer</strong> 非常适合将高度自定义的短消息写入文本文件，但可能需要一些时间和精力才能实现。 对于大多数 IT 专业人员来说， <strong>Command Line Consumer</strong> 是一个不错的选择。使用此 Consumer ，您可以让 WMI 在事件发生时随时运行 PowerShell 脚本，例如对 AD 组的更改。 让我们看看如何使用这个永久事件使用者来发现对 Enterprise Admins 组成员的更改。</p>
<h3 id="创建永久事件处理程序"><a href="#创建永久事件处理程序" class="headerlink" title="创建永久事件处理程序"></a>创建永久事件处理程序</h3><p>使用 WMI 永久事件处理，您需要在 CIM 数据库中创建三个对象。</p>
<ul>
<li>事件过滤器（Event filter）——过滤器告诉 WMI 要检测哪个事件，例如对 AD 组的更改。</li>
<li>事件消费者（Event consumer）——这告诉 WMI 要运行哪个永久事件消费者以及如何调用消费者，例如运行命令行消费者和运行 <code>Monitor.ps1</code>。</li>
<li>事件绑定（Event binding）——这将过滤器（要注意的事件）绑定到消费者（事件发生时要做什么）</li>
</ul>
<p>要执行这三个操作，您需要将新对象插入到三个特定的 WMI 系统类中。 WMI 系统类实例使 WMI 能够在您停止 PowerShell 会话、注销或重新启动主机后继续处理事件。</p>
<p>在下面的代码中，使用 <strong>Command Line Consumer</strong> 来检测对 AD 的企业管理员组的更改。 每次发生更改事件时，您都希望 WMI 运行特定的脚本，即 <code>Monitor.ps1</code>。 此脚本将 Enterprise Admins 组的当前成员列表显示到日志文件中，并报告该成员现在是否包含未经授权的用户。 如果脚本发现未经授权的用户现在是组成员，它会将详细信息写入文本文件供您稍后查看。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>此解决方案有几个步骤。 所以，请系好安全带，我们出发吧。</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>在本文中，您想要检测未经授权的用户是否是 Enterprise Admins 组的成员。 您必须首先创建授权用户的文件。 然后创建两个辅助函数来帮助您测试代码。 从主机中全方位删除 WMI 事件过滤器的功能非常有用，除非您打算让过滤器永远运行。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Create a list of valid users for the Enterprise Admins group</span></span><br><span class="line"><span class="variable">$OKUsersFile</span> = <span class="string">&#x27;C:\Foo\OKUsers.Txt&#x27;</span></span><br><span class="line"><span class="variable">$OKUsers</span>  =  <span class="string">@&#x27;</span></span><br><span class="line"><span class="string">Administrator</span></span><br><span class="line"><span class="string">JerryG</span></span><br><span class="line"><span class="string">&#x27;@</span></span><br><span class="line"><span class="variable">$OKUsers</span> | </span><br><span class="line">  <span class="built_in">Out-File</span> <span class="literal">-FilePath</span> <span class="variable">$OKUsersFile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Define two helper functions to get/remove permanent events</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Get-WMIPE</span></span> &#123;</span><br><span class="line">  <span class="string">&#x27;*** Event Filters Defined ***&#x27;</span></span><br><span class="line">  <span class="built_in">Get-CimInstance</span> <span class="literal">-Namespace</span> ROOT\subscription <span class="literal">-ClassName</span> __EventFilter  |</span><br><span class="line">    <span class="built_in">Where-Object</span> Name <span class="operator">-eq</span> <span class="string">&quot;EventFilter1&quot;</span> |</span><br><span class="line">     <span class="built_in">Format-Table</span> Name, Query</span><br><span class="line">  <span class="string">&#x27;***Consumer Defined ***&#x27;</span></span><br><span class="line">  <span class="variable">$NS</span> = <span class="string">&#x27;ROOT\subscription&#x27;</span></span><br><span class="line">  <span class="variable">$CN</span> = <span class="string">&#x27;CommandLineEventConsumer&#x27;</span></span><br><span class="line">  <span class="built_in">Get-CimInstance</span> <span class="literal">-Namespace</span> <span class="variable">$ns</span> <span class="literal">-ClassName</span>  <span class="variable">$CN</span> |</span><br><span class="line">    <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.name <span class="operator">-eq</span> <span class="string">&quot;EventConsumer1&quot;</span>&#125;  |</span><br><span class="line">     <span class="built_in">Format-Table</span> Name, CommandLineTemplate</span><br><span class="line">  <span class="string">&#x27;***Bindings Defined ***&#x27;</span></span><br><span class="line">  <span class="built_in">Get-CimInstance</span> <span class="literal">-Namespace</span> ROOT\subscription <span class="literal">-ClassName</span> __FilterToConsumerBinding |</span><br><span class="line">    <span class="built_in">Where-Object</span> <span class="literal">-FilterScript</span> &#123;<span class="variable">$_</span>.Filter.Name <span class="operator">-eq</span> <span class="string">&quot;EventFilter1&quot;</span>&#125; |</span><br><span class="line">      <span class="built_in">Format-Table</span> <span class="keyword">Filter</span>, Consumer</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Remove-WMIPE</span></span> &#123;</span><br><span class="line">  <span class="built_in">Get-CimInstance</span> <span class="literal">-Namespace</span> ROOT\subscription __EventFilter | </span><br><span class="line">    <span class="built_in">Where-Object</span> Name <span class="operator">-eq</span> <span class="string">&quot;EventFilter1&quot;</span> |</span><br><span class="line">      <span class="built_in">Remove-CimInstance</span></span><br><span class="line">  <span class="built_in">Get-CimInstance</span> <span class="literal">-Namespace</span> ROOT\subscription CommandLineEventConsumer | </span><br><span class="line">    <span class="built_in">Where-Object</span> Name <span class="operator">-eq</span> <span class="string">&#x27;EventConsumer1&#x27;</span> |</span><br><span class="line">      <span class="built_in">Remove-CimInstance</span></span><br><span class="line">  <span class="built_in">Get-CimInstance</span> <span class="literal">-Namespace</span> ROOT\subscription __FilterToConsumerBinding  |</span><br><span class="line">    <span class="built_in">Where-Object</span> <span class="literal">-FilterScript</span> &#123;<span class="variable">$_</span>.Filter.Name <span class="operator">-eq</span> <span class="string">&#x27;EventFilter1&#x27;</span>&#125;   |</span><br><span class="line">      <span class="built_in">Remove-CimInstance</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个步骤不产生输出。 当您创建 <code>OkUsers.txt</code> 文件时——确保文件中的用户实际上在您的 AD 中。</p>
<p>PS：<code>Get-CimInstance -Namespace ROOT\subscription __FilterToConsumerBinding</code>命令在windows powershell 5.1下执行会报错，暂不知道原因。</p>
<p>查看和删除可以使用 Get-WMIObject  cmdlet</p>
<p>Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding -Filter “__Path LIKE ‘%EventFilter1%’”</p>
<p>Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding -Filter “__Path LIKE ‘%EventFilter1%’” | Remove-WmiObject -Verbose</p>
<p><img src="https://ax-x.github.io/2023/04/17/PowerShell-Community/安全学习资料\文稿\16、钓鱼\关于PowerShell\1672938921071-3f3107cc-9101-4836-b9da-40c9005e136a.png" alt="img"></p>
<p>解决方案是重建 WMI 存储库。</p>
<p>起初我按照在线说明从 MOF 文件重建，但这些都不起作用，所以我备份了存储库，然后从另一台机器上复制了一个工作存储库。</p>
<p>路径: C:\Windows\System32\wbem\respository</p>
<h4 id="创建-WQL-事件查询和-WMI-事件过滤器"><a href="#创建-WQL-事件查询和-WMI-事件过滤器" class="headerlink" title="创建 WQL 事件查询和 WMI 事件过滤器"></a>创建 WQL 事件查询和 WMI 事件过滤器</h4><p>要告诉 WMI 您希望 WMI 检测什么事件，您可以创建一个 WMI 查询语言 (WQL) 查询。 在每个 WMI 命名空间中，您可以找到表示事件通知的各种系统类。 例如，您可以使用 <strong>__InstanceModificationEvent</strong> 类来检测实例的任何修改（在该命名空间中）。 您同样可以使用 <strong>__MethodInvocationEvent</strong> 类来跟踪 WMI 方法调用。 如果 Windows 主机中的任何地方发生变化，您可能可以使用 WMI 事件来检测变化。</p>
<p>下面是创建 WQL 查询和 WMI 事件过滤器的代码：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3. Create a WQL event filter query</span></span><br><span class="line"><span class="variable">$Group</span> = <span class="string">&#x27;Enterprise Admins&#x27;</span></span><br><span class="line"><span class="variable">$Query</span> = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">  SELECT * From __InstanceModificationEvent Within 10  </span></span><br><span class="line"><span class="string">   WHERE TargetInstance ISA &#x27;ds_group&#x27; AND </span></span><br><span class="line"><span class="string">         TargetInstance.ds_name = &#x27;<span class="variable">$Group</span>&#x27;</span></span><br><span class="line"><span class="string">&quot;@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Create the event filter</span></span><br><span class="line"><span class="variable">$Param</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">  QueryLanguage =  <span class="string">&#x27;WQL&#x27;</span></span><br><span class="line">  Query          =  <span class="variable">$Query</span></span><br><span class="line">  Name           =  <span class="string">&#x27;EventFilter1&#x27;</span></span><br><span class="line">  EventNameSpace =  <span class="string">&#x27;ROOT/directory/LDAP&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$IHT</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">  ClassName = <span class="string">&#x27;__EventFilter&#x27;</span></span><br><span class="line">  Namespace = <span class="string">&#x27;ROOT/subscription&#x27;</span></span><br><span class="line">  Property  = <span class="variable">$Param</span></span><br><span class="line">&#125;        </span><br><span class="line"><span class="variable">$InstanceFilter</span> = <span class="built_in">New-CimInstance</span> @IHT</span><br></pre></td></tr></table></figure>

<p>在此代码中（不产生任何输出），过滤器查询没有说明查询正在查看哪个命名空间，只是说明有一个目标类供 WMI 监视。 在事件过滤器中，会在 <strong>ROOT/Subscription</strong> 命名空间的 <strong>EventFilter</strong> 类中创建一个新实例。 该实例告诉 WMI 监视 <strong>ROOT/directory/LDAP</strong> 名称空间中的 <strong>ds_group</strong> 类。</p>
<h4 id="创建事件消费者"><a href="#创建事件消费者" class="headerlink" title="创建事件消费者"></a>创建事件消费者</h4><p>下一步是创建一个事件消费者——希望 WMI 在检测到事件发生时执行的操作。 在我们的示例中，我们希望 WMI 永久事件处理程序 COM 对象在事件发生时运行脚本 <code>Monitor.ps1</code>。 因此，只要 WMI 检测到对企业管理员组的更改，您就希望 WMI 运行脚本。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 5. Create Monitor.ps1</span></span><br><span class="line"><span class="variable">$MONITOR</span> = <span class="string">@&#x27;</span></span><br><span class="line"><span class="string">$LogFile   = &#x27;C:\Foo\Grouplog.Txt&#x27;</span></span><br><span class="line"><span class="string">$Group     = &#x27;Enterprise Admins&#x27;</span></span><br><span class="line"><span class="string">&quot;On:  [$(Get-Date)]  Group [$Group] was changed&quot; | </span></span><br><span class="line"><span class="string">  Out-File -Force $LogFile -Append -Encoding Ascii</span></span><br><span class="line"><span class="string">$ADGM = Get-ADGroupMember -Identity $Group</span></span><br><span class="line"><span class="string"># Display who&#x27;s in the group</span></span><br><span class="line"><span class="string">&quot;Group Membership&quot;</span></span><br><span class="line"><span class="string">$ADGM | Format-Table Name, DistinguishedName |</span></span><br><span class="line"><span class="string">  Out-File -Force $LogFile -Append  -Encoding Ascii</span></span><br><span class="line"><span class="string">$OKUsers = Get-Content -Path C:\Foo\OKUsers.txt</span></span><br><span class="line"><span class="string"># Look at who is not authorized</span></span><br><span class="line"><span class="string">foreach ($User in $ADGM) &#123;</span></span><br><span class="line"><span class="string">  if ($User.SamAccountName -notin $OKUsers) &#123;</span></span><br><span class="line"><span class="string">    &quot;Unauthorized user [$($User.SamAccountName)] added to $Group&quot;  | </span></span><br><span class="line"><span class="string">      Out-File -Force $LogFile -Append  -Encoding Ascii</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;**********************************`n`n&quot; | </span></span><br><span class="line"><span class="string">Out-File -Force $LogFile -Append -Encoding Ascii</span></span><br><span class="line"><span class="string">&#x27;@</span></span><br><span class="line"><span class="variable">$MONITOR</span> | <span class="built_in">Out-File</span> <span class="literal">-FilePath</span> C:\Foo\Monitor.ps1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. Create a WMI event consumer</span></span><br><span class="line"><span class="comment">#    The consumer runs PowerShell 7 to execute C:\Foo\Monitor.ps1</span></span><br><span class="line"><span class="comment"># Pwsh.exe是powershell 6.0之后调用powershell的二进制文件，5.1使用powershell.exe</span></span><br><span class="line"><span class="comment"># $CLT = &#x27;Pwsh.exe -File C:\Foo\Monitor.ps1&#x27;</span></span><br><span class="line"><span class="variable">$CLT</span> = <span class="string">&#x27;powershell.exe -File C:\Foo\Monitor.ps1&#x27;</span></span><br><span class="line"><span class="variable">$Param</span> =[<span class="type">ordered</span>] <span class="selector-tag">@</span>&#123;</span><br><span class="line">  Name                = <span class="string">&#x27;EventConsumer1&#x27;</span></span><br><span class="line">  CommandLineTemplate = <span class="variable">$CLT</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ECHT</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">  Namespace = <span class="string">&#x27;ROOT/subscription&#x27;</span></span><br><span class="line">  ClassName = <span class="string">&quot;CommandLineEventConsumer&quot;</span></span><br><span class="line">  Property  = <span class="variable">$param</span></span><br><span class="line">&#125;        </span><br><span class="line"><span class="variable">$InstanceConsumer</span> = <span class="built_in">New-CimInstance</span> @ECHT</span><br></pre></td></tr></table></figure>

<p>监控脚本相当简单——每次事件发生时，它都会将一些信息打印到日志文件中。 然后它会查看 Enterprise Admins 组是否包含未经授权的用户——如果是，脚本会将该事实报告到日志文件中。 这个脚本相当简单，你可以修饰。 如所须。 例如，您可以删除所有未经授权的用户。</p>
<p>要创建 WMI 事件使用者，请将新实例添加到命名空间 <strong>ROOT/Subscription</strong> 中的 <strong>CommandLineEventConsumer</strong> 类。</p>
<h4 id="绑定事件过滤器和事件消费者"><a href="#绑定事件过滤器和事件消费者" class="headerlink" title="绑定事件过滤器和事件消费者"></a>绑定事件过滤器和事件消费者</h4><p>将事件过滤器和事件消费者详细信息添加到 WMI 后，您需要绑定两者 - 告诉 WMI 检测该事件并在事件发生时运行该脚本。 例如，您可以预先创建多个事件过滤器和事件使用者。 绑定到位后，WMI 将启动监视过程。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 7. Bind the filter and consumer</span></span><br><span class="line"><span class="variable">$Param</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">  <span class="keyword">Filter</span>   = [<span class="type">ref</span>]<span class="variable">$InstanceFilter</span>     </span><br><span class="line">  Consumer = [<span class="type">ref</span>]<span class="variable">$InstanceConsumer</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$IBHT</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">  Namespace = <span class="string">&#x27;ROOT/subscription&#x27;</span></span><br><span class="line">  ClassName = <span class="string">&#x27;__FilterToConsumerBinding&#x27;</span></span><br><span class="line">  Property  = <span class="variable">$Param</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$InstanceBinding</span> = <span class="built_in">New-CimInstance</span> @IBHT</span><br></pre></td></tr></table></figure>

<h4 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h4><p>检查您的工作的一个好方法是调用您之前创建的 <code>Get-WMIPE</code> 函数。 你应该看到的是：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> &gt; <span class="comment"># 8. Viewing the event registration details</span></span><br><span class="line"><span class="built_in">PS</span> &gt; <span class="built_in">Get-WMIPE</span></span><br><span class="line">*** Event Filters Defined ***</span><br><span class="line"></span><br><span class="line">Name         Query</span><br><span class="line">----         -----</span><br><span class="line">EventFilter1   <span class="built_in">SELECT</span> * From __InstanceModificationEvent Within <span class="number">10</span></span><br><span class="line">                <span class="built_in">WHERE</span> TargetInstance ISA <span class="string">&#x27;ds_group&#x27;</span> AND</span><br><span class="line">                      TargetInstance.ds_name = <span class="string">&#x27;Enterprise Admins&#x27;</span></span><br><span class="line"></span><br><span class="line">***Consumer Defined ***</span><br><span class="line"></span><br><span class="line">Name           CommandLineTemplate</span><br><span class="line">----           -------------------</span><br><span class="line">EventConsumer1 Pwsh.exe <span class="operator">-File</span> C:\Foo\Monitor.ps1</span><br><span class="line"></span><br><span class="line">***Bindings Defined ***</span><br><span class="line"></span><br><span class="line"><span class="keyword">Filter</span>                                Consumer</span><br><span class="line">------                                --------</span><br><span class="line">__EventFilter (Name = <span class="string">&quot;EventFilter1&quot;</span>) CommandLineEventConsumer (Name = <span class="string">&quot;EventConsumer1&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>因此，在创建事件查询、事件过滤器、事件消费者和消费者绑定过滤器之后，您可以测试您的工作。 最简单的测试方法是向组中添加一个新用户。 然后，等待几秒钟让 WMI 处理事件，然后查看输出。 如果一切正常，您应该会看到以下输出：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> &gt; <span class="comment"># 9. Adding a user to the Enterprise Admins group</span></span><br><span class="line"><span class="built_in">PS</span> &gt; <span class="built_in">Add-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&#x27;Enterprise admins&#x27;</span> <span class="literal">-Members</span> Malcolm</span><br><span class="line"><span class="built_in">PS</span> &gt; </span><br><span class="line"><span class="built_in">PS</span> &gt; <span class="comment"># 10. Viewing the Grouplog.txt file</span></span><br><span class="line"><span class="built_in">PS</span> &gt; <span class="built_in">Get-Content</span> <span class="literal">-Path</span> C:\Foo\Grouplog.txt</span><br><span class="line">On:  [<span class="number">04</span>/<span class="number">20</span>/<span class="number">2021</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">49</span>]  <span class="built_in">Group</span> [<span class="type">Enterprise</span> <span class="type">Admins</span>] was changed</span><br><span class="line"></span><br><span class="line">Name          DistinguishedName</span><br><span class="line">----          -----------------</span><br><span class="line">Malcolm       CN=Malcolm,OU=IT,DC=Reskit,DC=Org</span><br><span class="line">Jerry Garcia  CN=Jerry Garcia,OU=IT,DC=Reskit,DC=Org</span><br><span class="line">Administrator CN=Administrator,CN=Users,DC=Reskit,DC=Org</span><br><span class="line"></span><br><span class="line">Unauthorized user [<span class="type">Malcolm</span>] added to Enterprise Admins</span><br><span class="line">**********************************</span><br></pre></td></tr></table></figure>

<h3 id="故障排除"><a href="#故障排除" class="headerlink" title="故障排除"></a>故障排除</h3><p>这段代码当然应该“正常工作”。 如果没有，您需要执行故障排除，需要检查以下三点：</p>
<ul>
<li>WQL 查询是否正确？</li>
<li>事件和订阅类是否在您认为它们所在的命名空间中？</li>
<li><code>Monitor.ps1</code> 脚本是否在执行您真正想要的操作？</li>
</ul>
<p><strong>Microsoft-Windows-WMI-Activity/Operational</strong> 事件日志可用于跟踪问题。 如果您遇到困难，请随时访问 <a target="_blank" rel="noopener" href="https://community.spiceworks.com/programming/powershell">Spiceworks PowerShell 论坛</a>。</p>
<h3 id="删除WMI事件相关实例"><a href="#删除WMI事件相关实例" class="headerlink" title="删除WMI事件相关实例"></a>删除WMI事件相关实例</h3><p>当你不想使用这个 WMI 筛选器时，请确保进行清理。 如果你不希望过滤器永远运行，尽快将其删除。 要删除它，请调用 <code>Remove-WMIPE</code> 函数。 您现在应该能从 Enterprise Admins 组中删除任何不合适的用户：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 11. Tidying up</span></span><br><span class="line"><span class="built_in">Remove-WMIPE</span>    <span class="comment"># invoke this function you defined above</span></span><br><span class="line"><span class="variable">$RGMHT</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">  Identity = <span class="string">&#x27;Enterprise Admins&#x27;</span></span><br><span class="line">  Member   = <span class="string">&#x27;Malcolm&#x27;</span></span><br><span class="line">  Confirm  = <span class="variable">$false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Remove-ADGroupMember</span> @RGMHT</span><br></pre></td></tr></table></figure>

<p>此步骤不产生任何输出。 您需要再次调用 <code>Get-WMIPE</code> 以验证您是否已删除所有三个类的实例。</p>
<h3 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h3><p>WMI 事件非常强大且易于实现。 您可以订阅数以千计的 WMI 事件，它们可能有助于排除活动故障。 像这篇文章中的案例，检查 AD 组的未授权更改者。 WMI 文档没有提供您可能感兴趣的事件的权威指南——至少我没能找到。</p>
<p>有关在 PowerShell 7 中使用 WMI 的更多详细信息，请参阅我最近出版的 <a target="_blank" rel="noopener" href="https://www.wiley.com/en-gb/PowerShell+7+for+IT+Professionals-p-9781119644705">PowerShell 7</a> 一书。 我将第 9 章专门介绍 WMI 和使用 CIM cmdlet。 您可以从这篇博文和我的 [GitHub 存储库](<a target="_blank" rel="noopener" href="https://github.com/doctordns/Wiley20/tree/master/09">https://github.com/doctordns/Wiley20/tree/master/09</a> - WMI) 中的那一章中找到脚本。</p>
<h3 id="WMI事件案例"><a href="#WMI事件案例" class="headerlink" title="WMI事件案例"></a>WMI事件案例</h3><p><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/powershell-community/how-can-i-be-notified-any-time-a-service-goes-down/">https://devblogs.microsoft.com/powershell-community/how-can-i-be-notified-any-time-a-service-goes-down/</a></p>
<p>作业：如何监控系统新增计划任务。</p>
<h2 id="如何使用-PowerShell-配置文件"><a href="#如何使用-PowerShell-配置文件" class="headerlink" title="如何使用 PowerShell 配置文件"></a>如何使用 PowerShell 配置文件</h2><p>问题：我想个性化 PowerShell 的工作方式。 我听说我可以使用一种称为配置文件的东西来执行此操作，但是当我尝试查找有关配置文件的信息时，却一无所获。 没有 <code>New-Profile</code> cmdlet，所以我不知道如何创建这样的东西。 你能帮我吗？</p>
<p>解答：配置文件是 PowerShell 的一个强大部分，允许您为您的环境自定义 PowerShell。 它们易于创建并支持一系列部署方案。</p>
<h3 id="什么是powershell配置文件？"><a href="#什么是powershell配置文件？" class="headerlink" title="什么是powershell配置文件？"></a>什么是powershell配置文件？</h3><p>在解释配置文件之前，让我们先检查一下 PowerShell 主机。 PowerShell 主机是托管 PowerShell 以允许您使用它的程序。 常见的 PowerShell 主机包括 Windows PowerShell 控制台、Windows PowerShell ISE、PowerShell 7 控制台和 VS 代码。 每个主机都支持使用配置文件。</p>
<p>配置文件是 PowerShell 主机在您每次启动该 PowerShell 主机时自动加载和执行的 PowerShell 脚本文件。 该脚本实际上是点源（dot-sourced）的，因此您在配置文件脚本中定义的任何变量、函数等在 PowerShell 会话中仍然可用，这非常方便。 我使用配置文件来创建 PowerShell 驱动器、各种有用的变量和一些有用的（对我来说！）函数。</p>
<p>每个 PowerShell 主机都有 4 个单独的配置文件，如下所示：</p>
<ul>
<li>对这个主机，这个用户</li>
<li>对这个主机，所有用户</li>
<li>所有主机，该用户</li>
<li>所有主机，所有用户</li>
</ul>
<p>为什么这么多，你可能会问。 因为拥有这四个配置文件可以为您提供大量部署机会。 例如，您可以拥有一个配置文件，为机器上的每个 PowerShell 主机和用户定义公司别名或标准 PS 驱动器。 您可以拥有“此主机”配置文件，这些配置文件定义了特定于主机的自定义项，这些自定义项可能因 PowerShell 主机而异。 例如，在我的 VS 代码配置文件中，我使用 Set-PSReadLineOption 根据我使用的颜色主题设置标记颜色。 与 PowerShell 中的许多事情一样，PowerShell 团队为您在部署 PowerShell 和 PowerShell 主机时可能遇到的每个场景设计了配置文件。</p>
<p>实际上，“此主机、此用户”配置文件是您最常用的配置文件，但同时拥有这四种配置文件可提供相当大的部署灵活性。 你可以自行选择！</p>
<h3 id="我怎么找到它们"><a href="#我怎么找到它们" class="headerlink" title="我怎么找到它们"></a>我怎么找到它们</h3><p>另一个常见问题是：这些文件在哪里，它们是如何命名的？ 事实证明，就像 PowerShell 的许多事情一样，您可以在 PowerShell 本身中找到问题的答案。 在本例中，在 PowerShell 自动变量 <code>**$PROFILE**</code> 中。</p>
<p>PowerShell 中的自动变量，是由 PowerShell 自己创建并可供使用的变量。 这些变量是在您启动主机时由 PowerShell 创建的。 有关自动变量的更多详细信息，请参阅<a target="_blank" rel="noopener" href="https://docs.microsoft.com/powershell/module/microsoft.powershell.core/about/about_automatic_variables">自动变量帮助文本</a>。</p>
<h3 id="PROFILE-变量"><a href="#PROFILE-变量" class="headerlink" title="$PROFILE 变量"></a>$PROFILE 变量</h3><p><code>**$PROFILE**</code> 变量是 PowerShell 在启动期间在每个会话中创建的自动变量。 这个变量有一个 <code>ToString()</code> 方法和四个额外的注释属性，告诉你这个主机在哪里找到它的配置文件。</p>
<p>要确定四个 PowerShell 脚本的位置和填充脚本名称，您可以执行如下操作：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span>&gt; <span class="comment"># what host?   </span></span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="variable">$host</span>.Name</span><br><span class="line">ConsoleHost</span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="comment"># Where are the profiles?</span></span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="variable">$PROFILE</span> | <span class="built_in">Get-Member</span> <span class="literal">-MemberType</span> NoteProperty </span><br><span class="line">   TypeName: System.String</span><br><span class="line">Name                   MemberType   Definition</span><br><span class="line">----                   ----------   ----------</span><br><span class="line">AllUsersAllHosts       NoteProperty string AllUsersAllHosts=C:\Program Files\PowerShell\<span class="number">7</span>\profile.ps1</span><br><span class="line">AllUsersCurrentHost    NoteProperty string AllUsersCurrentHost=C:\Program Files\PowerShell\<span class="number">7</span>\Microsoft.PowerShell_profile.ps1</span><br><span class="line">CurrentUserAllHosts    NoteProperty string CurrentUserAllHosts=C:\Users\doctordns\Documents\PowerShell\profile.ps1</span><br><span class="line">CurrentUserCurrentHost NoteProperty string CurrentUserCurrentHost=C:\Users\doctordns\Documents\PowerShell\Microsoft.PowerShell_profile.ps1</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="comment"># What does the $PROFILE variable itself contain?</span></span><br><span class="line"><span class="built_in">PS</span>&gt; <span class="variable">$PROFILE</span></span><br><span class="line">C:\Users\doctordns\Documents\PowerShell\Microsoft.PowerShell_profile.ps1</span><br></pre></td></tr></table></figure>

<p>此示例来自在 VS Code 中运行 PowerShell 7 的 Windows 10 客户端。 在示例中，您可以看到 <code>**$PROFILE**</code> 变量包含四个注释属性，其中包含每个配置文件的位置。此外，您可以看到 <code>**$PROFILE**</code> 变量的值是 <strong>CurrentUserCurrentHost</strong> 配置文件的名称。 为简单起见，您可以运行 <code>Notepad $Profile</code> 以在记事本中调出配置文件（或使用 VS Code！）</p>
<h3 id="您可以在配置文件脚本中做什么？"><a href="#您可以在配置文件脚本中做什么？" class="headerlink" title="您可以在配置文件脚本中做什么？"></a>您可以在配置文件脚本中做什么？</h3><p>您几乎可以在配置文件中做任何您想做的事情来创建最适合您的环境。 我发现该配置文件对于创建变量和短别名、PS 驱动器等非常有用，如下所示。 作为您可以在配置文件中执行的操作的示例，为了让您入门，我已将两个示例配置文件文件发布到 GitHub：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/doctordns/PACKT-PS7/blob/master/scripts/goodies/Microsoft.PowerShell_Profile.ps1">A profile for the PowerShell 7 console</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/doctordns/PACKT-PS7/blob/master/scripts/goodies/Microsoft.VSCode_profile.ps1">A profile for VSCode</a></li>
</ul>
<p>这些样本做了很多有用的事情，包括：</p>
<ul>
<li>覆盖一些默认参数值</li>
<li>更新格式枚举限制</li>
<li>将“主”目录设置为非标准位置</li>
<li>创建个人别名</li>
<li>创建 PowerShell 凭据对象</li>
</ul>
<p>这些都是根据您的喜好定制环境的东西。 我使用一些个人别名作为标准别名的替代品——如果只是为了节省打字时间。 创建个人变量或更新自动变量可能很有用。</p>
<p>虽然创建凭证对象可能很有用，但它是否是一件好事还有待商榷。 在这种情况下，凭据适用于我在<a target="_blank" rel="noopener" href="https://smile.amazon.co.uk/Windows-Server-Automation-PowerShell-Cookbook-ebook/dp/B0977JDL7K/ref=sr_1_1?dchild=1&keywords=Windows+Server+Automation+with+PowerShell+Cookbook+-+Fourth+Edition&qid=1624277697&s=books&sr=1-1">最近的 PowerShell 书</a>中使用的一组 VM，以说明如何在企业中使用 PowerShell。 由于它们都是本地 VM 且仅用于测试，因此创建一个常用的凭据对象很有用。</p>
<h3 id="需要注意"><a href="#需要注意" class="headerlink" title="需要注意"></a>需要注意</h3><p>配置文件很容易让人忘乎所以。 在 PowerShell 3.0 时代的某一时刻，我的配置文件超过 700 行。 我刚刚放弃了我在 Internet 上找到的所有这些很酷的东西（并且再也没有使用过它们）因此，启动 PowerShell 或 ISE 花了一些时间。 很容易看到一些很酷的代码，然后将其添加到您的个人资料中。 我建议您定期仔细查看每个配置文件，并在可能的情况下对其进行修整。</p>
<h3 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a>总结</h3><p>配置文件是可用于自定义 PowerShell 环境的 PowerShell 脚本。 每个主机有 4 个配置文件，您可以通过检查 <code>**$Profile**</code> 自动变量看到。</p>

      
    </div>
    
    
    
	

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Ax-x
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://ax-x.github.io/2023/04/17/PowerShell-Community/" title="PowerShell Community">https://ax-x.github.io/2023/04/17/PowerShell-Community/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag"><i class="fa fa-tag"></i> 学习笔记</a>
          
            <a href="/tags/PowerShell-Community/" rel="tag"><i class="fa fa-tag"></i> PowerShell Community</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/08/29/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91-PC%E5%BE%AE%E4%BF%A1%E7%89%88/" rel="next" title="微信小程序反编译-PC微信版">
                <i class="fa fa-chevron-left"></i> 微信小程序反编译-PC微信版
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">
		

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
		
      
		
      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/head_portrait.png"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
		
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Ax-x" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87PowerShell%E6%9B%B4%E6%94%B9%E9%A9%B1%E5%8A%A8%E5%99%A8%E5%AD%97%E6%AF%8D%E5%92%8C%E6%A0%87%E7%AD%BE"><span class="nav-number">1.</span> <span class="nav-text">通过PowerShell更改驱动器字母和标签</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WMI%E7%B1%BB%EF%BC%8C%E7%B1%BB%E5%B1%9E%E6%80%A7%E5%92%8C%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="nav-number">1.1.</span> <span class="nav-text">WMI类，类属性和类方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A2%E7%B4%A2WMI%E7%B1%BB%E5%B1%9E%E6%80%A7"><span class="nav-number">1.2.</span> <span class="nav-text">探索WMI类属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96WMI%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.</span> <span class="nav-text">获取WMI属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%8D%A2%E9%A9%B1%E5%8A%A8%E5%99%A8%E6%A0%87%E7%AD%BE"><span class="nav-number">1.4.</span> <span class="nav-text">更换驱动器标签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%8D%A2%E9%A9%B1%E5%8A%A8%E5%99%A8%E5%8F%B7"><span class="nav-number">1.5.</span> <span class="nav-text">更换驱动器号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.6.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%B4%E6%95%AC%E6%84%9F%E8%B0%A2"><span class="nav-number">1.7.</span> <span class="nav-text">致敬感谢</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E6%AF%94%E5%9C%A8PowerShell-7%E5%92%8CWindows-PowerShell-5-1%E4%B8%AD%E4%BD%BF%E7%94%A8Get-Service"><span class="nav-number">2.</span> <span class="nav-text">对比在PowerShell 7和Windows PowerShell 5.1中使用Get-Service</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Get-Service%E8%8E%B7%E5%8F%96Windows%E6%9C%8D%E5%8A%A1%E5%B1%9E%E6%80%A7"><span class="nav-number">2.1.</span> <span class="nav-text">使用Get-Service获取Windows服务属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PowerShell-7"><span class="nav-number">2.2.</span> <span class="nav-text">PowerShell 7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows-Powershell-5-1"><span class="nav-number">2.3.</span> <span class="nav-text">Windows Powershell 5.1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">2.4.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%98%A8%E5%A4%A9%E7%9A%84%E6%97%A5%E6%9C%9F"><span class="nav-number">3.</span> <span class="nav-text">获取昨天的日期</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PowerShell%E4%B8%AD%E7%9A%84%E6%97%A5%E6%9C%9F"><span class="nav-number">3.1.</span> <span class="nav-text">PowerShell中的日期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%98%A8%E5%A4%A9%E7%9A%84%E6%97%A5%E6%9C%9F-1"><span class="nav-number">3.2.</span> <span class="nav-text">获取昨天的日期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%98%A8%E5%A4%A9%E7%9A%84%E6%97%A5%E6%9C%9F"><span class="nav-number">3.3.</span> <span class="nav-text">使用昨天的日期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-2"><span class="nav-number">3.4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%B4%E6%95%AC%E6%84%9F%E8%B0%A2-1"><span class="nav-number">3.5.</span> <span class="nav-text">致敬感谢</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E6%96%B0%E5%91%98%E5%B7%A5PowerShell%E8%84%9A%E6%9C%AC%E4%B8%AD%E5%88%A9%E7%94%A8XML"><span class="nav-number">4.</span> <span class="nav-text">在新员工PowerShell脚本中利用XML</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF"><span class="nav-number">4.1.</span> <span class="nav-text">场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A5%E9%97%A8-%E5%88%9B%E5%BB%BAXML"><span class="nav-number">4.2.</span> <span class="nav-text">入门 - 创建XML</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PowerShell-%E4%BD%BF%E7%94%A8XML"><span class="nav-number">4.3.</span> <span class="nav-text">PowerShell - 使用XML</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E7%94%A8%E7%9A%84%E7%AC%94%E8%AE%B0"><span class="nav-number">4.4.</span> <span class="nav-text">有用的笔记</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-3"><span class="nav-number">4.5.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E6%98%AF%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98"><span class="nav-number">5.</span> <span class="nav-text">如何判断一个用户是本地管理员</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84"><span class="nav-number">5.1.</span> <span class="nav-text">本地用户和组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Microsoft-PowerShell-LocalAccounts%E6%A8%A1%E5%9D%97"><span class="nav-number">5.2.</span> <span class="nav-text">Microsoft.PowerShell.LocalAccounts模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%98%AF%E5%90%A6%E4%B8%BA%E7%AE%A1%E7%90%86%E5%91%98"><span class="nav-number">5.3.</span> <span class="nav-text">用户是否为管理员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-4"><span class="nav-number">5.4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%B4%E6%95%AC"><span class="nav-number">5.5.</span> <span class="nav-text">致敬</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8-Active-Directory-%E4%B8%AD%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%9E%E6%8E%A5"><span class="nav-number">6.</span> <span class="nav-text">在 Active Directory 中测试与计算机的连接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8ActiveDirectory%E6%A8%A1%E5%9D%97"><span class="nav-number">6.1.</span> <span class="nav-text">使用ActiveDirectory模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7-Property-%E5%8F%82%E6%95%B0-Parameter-%E6%9C%AA%E5%AF%B9%E9%BD%90"><span class="nav-number">6.2.</span> <span class="nav-text">属性(Property)&#x2F;参数(Parameter) 未对齐</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ForEach-Object-%E6%9D%A5%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98"><span class="nav-number">6.3.</span> <span class="nav-text">ForEach-Object 来解决问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%AF%E6%89%A9%E5%B1%95%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F"><span class="nav-number">6.4.</span> <span class="nav-text">使用可扩展类型系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-5"><span class="nav-number">6.5.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%B4%E6%95%AC-1"><span class="nav-number">6.6.</span> <span class="nav-text">致敬</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E7%9B%91%E6%8E%A7-AD-%E7%BB%84%E6%88%90%E5%91%98%E7%9A%84%E5%8F%98%E5%8C%96"><span class="nav-number">7.</span> <span class="nav-text">如何监控 AD 组成员的变化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WMI"><span class="nav-number">7.1.</span> <span class="nav-text">WMI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WMI-%E4%BA%8B%E4%BB%B6"><span class="nav-number">7.2.</span> <span class="nav-text">WMI 事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B0%B8%E4%B9%85%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">7.3.</span> <span class="nav-text">永久事件消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%B0%B8%E4%B9%85%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="nav-number">7.4.</span> <span class="nav-text">创建永久事件处理程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">7.5.</span> <span class="nav-text">解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">7.5.1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-WQL-%E4%BA%8B%E4%BB%B6%E6%9F%A5%E8%AF%A2%E5%92%8C-WMI-%E4%BA%8B%E4%BB%B6%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">7.5.2.</span> <span class="nav-text">创建 WQL 事件查询和 WMI 事件过滤器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">7.5.3.</span> <span class="nav-text">创建事件消费者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A%E4%BA%8B%E4%BB%B6%E8%BF%87%E6%BB%A4%E5%99%A8%E5%92%8C%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">7.5.4.</span> <span class="nav-text">绑定事件过滤器和事件消费者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5"><span class="nav-number">7.5.5.</span> <span class="nav-text">检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">7.5.6.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4"><span class="nav-number">7.6.</span> <span class="nav-text">故障排除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4WMI%E4%BA%8B%E4%BB%B6%E7%9B%B8%E5%85%B3%E5%AE%9E%E4%BE%8B"><span class="nav-number">7.7.</span> <span class="nav-text">删除WMI事件相关实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-6"><span class="nav-number">7.8.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WMI%E4%BA%8B%E4%BB%B6%E6%A1%88%E4%BE%8B"><span class="nav-number">7.9.</span> <span class="nav-text">WMI事件案例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-PowerShell-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">8.</span> <span class="nav-text">如何使用 PowerShell 配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFpowershell%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%9F"><span class="nav-number">8.1.</span> <span class="nav-text">什么是powershell配置文件？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%91%E6%80%8E%E4%B9%88%E6%89%BE%E5%88%B0%E5%AE%83%E4%BB%AC"><span class="nav-number">8.2.</span> <span class="nav-text">我怎么找到它们</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PROFILE-%E5%8F%98%E9%87%8F"><span class="nav-number">8.3.</span> <span class="nav-text">$PROFILE 变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%82%A8%E5%8F%AF%E4%BB%A5%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%84%9A%E6%9C%AC%E4%B8%AD%E5%81%9A%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">8.4.</span> <span class="nav-text">您可以在配置文件脚本中做什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F"><span class="nav-number">8.5.</span> <span class="nav-text">需要注意</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-7"><span class="nav-number">8.6.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      
    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ax-x</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">63.6k</span>
  
</div>









        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
